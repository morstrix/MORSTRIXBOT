<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art Drafts</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #000);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è —Å—ñ—Ç–∫–∏ */
        #canvas-container {
            border: 2px solid var(--tg-theme-text-color, #ccc); /* –°—ñ—Ä–∏–π —Ñ—Ä–µ–π–º */
            background-color: var(--tg-theme-text-color, #ccc); /* –ö–æ–ª—ñ—Ä –º—ñ–∂ –ø—ñ–∫—Å–µ–ª—è–º–∏ */
            margin: 10px 0;
            display: inline-block;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* –•–æ–ª—Å—Ç –¥–ª—è –ø—ñ–∫—Å–µ–ª—å-–∞—Ä—Ç—É */
        #pixelCanvas {
            display: block;
            touch-action: none; /* –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∫—Ä–æ–ª—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö –ø—ñ–¥ —á–∞—Å –º–∞–ª—é–≤–∞–Ω–Ω—è */
        }

        /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –∫–Ω–æ–ø–æ–∫ */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--tg-theme-button-color, #50a7e8);
            color: var(--tg-theme-button-text-color, #fff);
            font-weight: bold;
        }
    </style>
</head>
<body>

    <p>–ö–≤–∞–¥—Ä–∞—Ç–∏–∫-–∞—Ä—Ç</p>

    <div class="controls">
        <button id="tool-white">‚ö™Ô∏è –ü–µ–Ω–∑–µ–ª—å</button>
        <button id="tool-eraser">üßº –ì—É–º–∫–∞</button>
        <button id="clear-canvas">‚ùå –û—á–∏—Å—Ç–∏—Ç–∏</button>
    </div>

    <div id="canvas-container">
        <canvas id="pixelCanvas" width="256" height="256"></canvas>
    </div>
    
    <input type="text" id="note-text" placeholder="–û–ø–∏—Å –∞—Ä—Ç—É (–Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" 
           style="width: 90%; padding: 10px; margin-top: 15px; border-radius: 8px; border: 1px solid #ccc;">


    <script>
        const GRID_SIZE = 16;
        const PIXEL_SIZE = 256 / GRID_SIZE;
        const DEFAULT_COLOR = '#808080'; // –°—ñ—Ä–∏–π (—Ñ—Ä–µ–π–º)
        const CANVAS_COLOR = '#f0f0f0'; // –ë—ñ–ª–∏–π —Ñ–æ–Ω
        
        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');
        const toolWhite = document.getElementById('tool-white');
        const toolEraser = document.getElementById('tool-eraser');
        const clearCanvasBtn = document.getElementById('clear-canvas');
        
        let currentColor = '#ffffff'; // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä - –ë—ñ–ª–∏–π

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ–ª–æ—Ç–Ω–∞ (–º–∞–ª—é—î–º–æ —Å—ñ—Ä—É —Å—ñ—Ç–∫—É —Ç–∞ –±—ñ–ª–∏–π —Ñ–æ–Ω)
        function initCanvas() {
            ctx.fillStyle = CANVAS_COLOR;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawGrid();
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É "–ó–±–µ—Ä–µ–≥—Ç–∏" –≤ Telegram WebApp
            Telegram.WebApp.MainButton.text = "–ó–ë–ï–†–ï–ì–¢–ò –ê–†–¢";
            Telegram.WebApp.MainButton.show();
        }

        function drawGrid() {
            ctx.strokeStyle = DEFAULT_COLOR;
            ctx.lineWidth = 1;
            for (let i = 0; i < GRID_SIZE; i++) {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó
                ctx.beginPath();
                ctx.moveTo(0, i * PIXEL_SIZE);
                ctx.lineTo(canvas.width, i * PIXEL_SIZE);
                ctx.stroke();
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó
                ctx.beginPath();
                ctx.moveTo(i * PIXEL_SIZE, 0);
                ctx.lineTo(i * PIXEL_SIZE, canvas.height);
                ctx.stroke();
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è –ø—ñ–∫—Å–µ–ª—è
        function drawPixel(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—ñ–∫—Å–µ–ª—è
            const pixelX = Math.floor(x / PIXEL_SIZE);
            const pixelY = Math.floor(y / PIXEL_SIZE);

            // –ú–∞–ª—é—î–º–æ –∫–≤–∞–¥—Ä–∞—Ç
            ctx.fillStyle = currentColor;
            ctx.fillRect(
                pixelX * PIXEL_SIZE + 1, // +1 –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—ó –ª—ñ–Ω—ñ—ó —Å—ñ—Ç–∫–∏
                pixelY * PIXEL_SIZE + 1,
                PIXEL_SIZE - 2, // -2 –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—ó –ª—ñ–Ω—ñ—ó —Å—ñ—Ç–∫–∏
                PIXEL_SIZE - 2
            );
        }

        // --- –û–±—Ä–æ–±–Ω–∏–∫–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ ---
        toolWhite.onclick = () => {
            currentColor = '#ffffff';
            toolWhite.style.backgroundColor = 'green';
            toolEraser.style.backgroundColor = '';
        };

        toolEraser.onclick = () => {
            currentColor = CANVAS_COLOR; // –ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É –¥–ª—è —Å—Ç–∏—Ä–∞–Ω–Ω—è
            toolEraser.style.backgroundColor = 'green';
            toolWhite.style.backgroundColor = '';
        };

        clearCanvasBtn.onclick = () => {
            initCanvas();
        };

        // --- –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –º–∏—à—ñ/–¥–æ—Ç–∏–∫—É ---
        let isDrawing = false;

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            drawPixel(e);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                drawPixel(e);
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });
        
        // --- –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ Telegram WebApp ---
        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            saveDrawing();
        });

        // --- –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ---
        function saveDrawing() {
            // 1. –û—Ç—Ä–∏–º—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ base64 PNG
            const imageDataURL = canvas.toDataURL('image/png'); 
            const noteText = document.getElementById('note-text').value;

            // 2. –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –±–æ—Ç—É
            const dataToSend = JSON.stringify({
                type: 'pixel_art', 
                data: imageDataURL, 
                note: noteText 
            });

            // 3. –ù–∞–¥—Å–∏–ª–∞—î–º–æ –¥–∞–Ω—ñ –±–æ—Ç—É
            Telegram.WebApp.sendData(dataToSend);
            
            // WebApp –±—É–¥–µ –∑–∞–∫—Ä–∏—Ç–æ –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ –±–æ—Ç–∞
        }

        // –ó–∞–ø—É—Å–∫
        Telegram.WebApp.ready();
        initCanvas();

    </script>
</body>
</html>