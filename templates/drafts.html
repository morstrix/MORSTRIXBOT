<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pixel Grid</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --pixel-font: 'Press Start 2P', cursive;
            --bg-color: #000000;
            --main-color: #0F0; /* –ó–µ–ª–µ–Ω–∏–π */
            --frame-color: #303030; /* –¢–µ–º–Ω–æ-—Å—ñ—Ä–∏–π –¥–ª—è —Ä–∞–º–æ–∫ */
            --graphite-frame: #505050; /* –ì—Ä–∞—Ñ—ñ—Ç–æ–≤–∏–π —Ñ—Ä–µ–π–º –¥–ª—è –∞—Ä—Ç—É */
            --white-color: #FFFFFF;
            --modal-bg: #111;
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--bg-color);
            color: var(--main-color);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            touch-action: manipulation; /* –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—é/–ø—Ä–æ–∫—Ä—É—Ç—Ü—ñ */
        }

        /* --- –®–∞—Ö–º–∞—Ç–Ω–∞ —Å—ñ—Ç–∫–∞ --- */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 –∫–æ–ª–æ–Ω–æ–∫ */
            gap: 10px;
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }

        .grid-cell {
            aspect-ratio: 1 / 1; /* –ö–≤–∞–¥—Ä–∞—Ç–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ */
            border: 2px solid var(--frame-color);
            background-color: var(--modal-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .grid-cell:hover {
            border-color: var(--main-color);
        }

        /* --- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: var(--modal-bg);
            border: 2px solid var(--main-color);
            padding: 20px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            text-align: center;
        }
        
        .modal-content h3 {
            margin-top: 0;
            font-size: 14px;
        }

        .modal-button {
            font-family: var(--pixel-font);
            background-color: var(--main-color);
            color: var(--bg-color);
            border: none;
            padding: 15px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px;
            display: block;
            width: 100%;
        }

        .modal-button.secondary {
            background-color: var(--frame-color);
            color: var(--white-color);
        }
        
        .modal-button.delete {
            background-color: #8B0000; /* –¢–µ–º–Ω–æ-—á–µ—Ä–≤–æ–Ω–∏–π */
            color: var(--white-color);
        }

        /* --- –ü–æ–ª—è –≤–≤–æ–¥—É --- */
        input[type="text"],
        input[type="datetime-local"],
        textarea {
            font-family: var(--pixel-font);
            background-color: var(--bg-color);
            color: var(--white-color);
            border: 2px solid var(--frame-color);
            padding: 10px;
            width: calc(100% - 24px); /* –í—Ä–∞—Ö—É–≤–∞–Ω–Ω—è padding + border */
            margin-bottom: 10px;
            font-size: 10px;
        }
        textarea {
            height: 100px;
            resize: none;
        }

        /* --- –†–µ–¥–∞–∫—Ç–æ—Ä –ê—Ä—Ç—É --- */
        #art-editor {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        #canvas-container {
            border: 5px solid var(--graphite-frame); /* –ì—Ä–∞—Ñ—ñ—Ç–æ–≤–∏–π —Ñ—Ä–µ–π–º */
            background-color: var(--white-color);
            touch-action: none; /* –î–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è –ø–∞–ª—å—Ü–µ–º */
        }
        
        .art-tools {
            display: flex;
            gap: 10px;
        }
        
        .art-tool {
            font-family: var(--pixel-font);
            background-color: var(--frame-color);
            color: var(--white-color);
            border: 2px solid var(--frame-color);
            padding: 10px;
            cursor: pointer;
            font-size: 10px;
        }
        .art-tool.active {
            border-color: var(--main-color);
        }
        
    </style>
</head>
<body>

    <h3>Pixel Grid 3x5</h3>
    <div id="grid-container"></div>

    <div id="modal-choice" class="modal">
        <div class="modal-content">
            <h3>–û–±—Ä–∞—Ç–∏ —Ç–∏–ø</h3>
            <button id="btn-choice-note" class="modal-button">üìù –ù–æ—Ç–∞—Ç–∫–∞</button>
            <button id="btn-choice-art" class="modal-button">üé® –ê—Ä—Ç</button>
            <button id="btn-choice-reminder" class="modal-button">‚è∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</button>
            <hr style="border-color: var(--frame-color);">
            <button id="btn-choice-delete" class="modal-button delete">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏</button>
            <button id="btn-choice-cancel" class="modal-button secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div id="modal-note" class="modal">
        <div class="modal-content">
            <h3>–¢–µ–∫—Å—Ç–æ–≤–∞ –Ω–æ—Ç–∞—Ç–∫–∞</h3>
            <textarea id="note-text" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç..."></textarea>
            <button id="btn-note-save" class="modal-button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button id="btn-note-cancel" class="modal-button secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div id="modal-art" class="modal">
        <div class="modal-content">
            <h3>–ö–≤–∞–¥—Ä–∞—Ç–∏–∫-–ê—Ä—Ç</h3>
            <div id="art-editor">
                <div class="art-tools">
                    <button id="tool-draw-s" class="art-tool active">–ú–∞—Ä–∫–µ—Ä (S)</button>
                    <button id="tool-draw-m" class="art-tool">–ú–∞—Ä–∫–µ—Ä (M)</button>
                    <button id="tool-erase-s" class="art-tool">–ì—É–º–∫–∞ (S)</button>
                    <button id="tool-erase-m" class="art-tool">–ì—É–º–∫–∞ (M)</button>
                </div>
                <div id="canvas-container">
                    <canvas id="pixelCanvas" width="256" height="256"></canvas>
                </div>
            </div>
            <button id="btn-art-save" class="modal-button">–ó–±–µ—Ä–µ–≥—Ç–∏ –ê—Ä—Ç</button>
            <button id="btn-art-cancel" class="modal-button secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
    
    <div id="modal-reminder" class="modal">
        <div class="modal-content">
            <h3>–ü—É—à-–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</h3>
            <input type="text" id="reminder-text" placeholder="–¢–µ–∫—Å—Ç –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è...">
            <input type="datetime-local" id="reminder-time">
            <button id="btn-reminder-save" class="modal-button">–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button>
            <button id="btn-reminder-cancel" class="modal-button secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>


    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–æ–∑—à–∏—Ä–∏—Ç–∏ Web App –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω

        const GRID_ROWS = 3;
        const GRID_COLS = 5;
        const GRID_TOTAL = GRID_ROWS * GRID_COLS;
        
        // --- –°—Ç–∞–Ω —Å—ñ—Ç–∫–∏ ---
        // –¶–µ –º–∞—Å–∏–≤, —è–∫–∏–π –±—É–¥–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –¥–∞–Ω—ñ –≤—Å—ñ—Ö –∫–ª—ñ—Ç–∏–Ω–æ–∫
        let gridState = [];
        
        // --- –ü–æ—Ç–æ—á–Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è ---
        let currentCellIndex = -1;

        // --- –ï–ª–µ–º–µ–Ω—Ç–∏ DOM ---
        const gridContainer = document.getElementById('grid-container');
        
        // –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞
        const modalChoice = document.getElementById('modal-choice');
        const modalNote = document.getElementById('modal-note');
        const modalArt = document.getElementById('modal-art');
        const modalReminder = document.getElementById('modal-reminder');

        // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ---
        function initApp() {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å—Ç–∞–Ω —Å—ñ—Ç–∫–∏ (15 –ø—É—Å—Ç–∏—Ö –∫–ª—ñ—Ç–∏–Ω–æ–∫)
            gridState = Array(GRID_TOTAL).fill(null).map(() => ({ type: 'empty' }));
            
            // –ú–∞–ª—é—î–º–æ —Å—ñ—Ç–∫—É
            renderGrid();
            
            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –≥–æ–ª–æ–≤–Ω—É –∫–Ω–æ–ø–∫—É Telegram
            tg.MainButton.text = "–ó–ë–ï–†–ï–ì–¢–ò –ó–ú–Ü–ù–ò";
            tg.MainButton.color = "#00FF00"; // –ó–µ–ª–µ–Ω–∏–π
            tg.MainButton.textColor = "#000000"; // –ß–æ—Ä–Ω–∏–π
            tg.MainButton.show();
        }

        // --- –†–µ–Ω–¥–µ—Ä—ñ–Ω–≥ —Å—ñ—Ç–∫–∏ ---
        function renderGrid() {
            gridContainer.innerHTML = ''; // –û—á–∏—â—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            
            gridState.forEach((cell, index) => {
                const cellEl = document.createElement('div');
                cellEl.className = 'grid-cell';
                
                // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É
                switch(cell.type) {
                    case 'note':
                        cellEl.innerHTML = 'üìù';
                        break;
                    case 'art':
                        cellEl.innerHTML = 'üé®';
                        break;
                    case 'reminder':
                        cellEl.innerHTML = '‚è∞';
                        break;
                    default: // 'empty'
                        cellEl.innerHTML = '+';
                        cellEl.style.color = 'var(--frame-color)';
                }
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É
                cellEl.onclick = () => onCellClick(index);
                
                gridContainer.appendChild(cellEl);
            });
        }
        
        // --- –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –ø–æ –∫–ª—ñ—Ç–∏–Ω—Ü—ñ ---
        function onCellClick(index) {
            currentCellIndex = index;
            const cellData = gridState[index];
            
            // –Ø–∫—â–æ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –Ω–µ –ø—É—Å—Ç–∞, –ø–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–∏–±–æ—Ä—É (–¥–µ —î –∫–Ω–æ–ø–∫–∞ "–í–∏–¥–∞–ª–∏—Ç–∏")
            // –∞–±–æ –æ–¥—Ä–∞–∑—É –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            if (cellData.type === 'empty') {
                openChoiceModal();
            } else {
                // –Ø–∫—â–æ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –ó–ê–ü–û–í–ù–ï–ù–ê, –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É –≤–∏–±–æ—Ä—É (–∑ –æ–ø—Ü—ñ—î—é "–í–∏–¥–∞–ª–∏—Ç–∏")
                openChoiceModal(true); 
            }
        }

        // --- –§—É–Ω–∫—Ü—ñ—ó –ú–æ–¥–∞–ª—å–Ω–∏—Ö –í—ñ–∫–æ–Ω ---
        function openChoiceModal(isFilled = false) {
            document.getElementById('btn-choice-delete').style.display = isFilled ? 'block' : 'none';
            document.getElementById('btn-choice-note').style.display = isFilled ? 'none' : 'block';
            document.getElementById('btn-choice-art').style.display = isFilled ? 'none' : 'block';
            document.getElementById('btn-choice-reminder').style.display = isFilled ? 'none' : 'block';
            modalChoice.style.display = 'flex';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
            currentCellIndex = -1; // –°–∫–∏–¥–∞—î–º–æ —ñ–Ω–¥–µ–∫—Å
        }

        // --- –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤–∏–±–æ—Ä—É ---
        document.getElementById('btn-choice-note').onclick = () => {
            modalChoice.style.display = 'none';
            modalNote.style.display = 'flex';
            document.getElementById('note-text').value = ''; // –û—á–∏—â—É—î–º–æ
        };
        
        document.getElementById('btn-choice-art').onclick = () => {
            modalChoice.style.display = 'none';
            modalArt.style.display = 'flex';
            initCanvas(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø–æ–ª–æ—Ç–Ω–æ
        };
        
        document.getElementById('btn-choice-reminder').onclick = () => {
            modalChoice.style.display = 'none';
            modalReminder.style.display = 'flex';
            document.getElementById('reminder-text').value = '';
            document.getElementById('reminder-time').value = '';
        };

        document.getElementById('btn-choice-delete').onclick = () => {
            gridState[currentCellIndex] = { type: 'empty' };
            renderGrid();
            closeModal(modalChoice);
        };
        
        document.getElementById('btn-choice-cancel').onclick = () => closeModal(modalChoice);
        
        // --- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–ù–æ—Ç–∞—Ç–∫–∞) ---
        document.getElementById('btn-note-save').onclick = () => {
            const text = document.getElementById('note-text').value;
            gridState[currentCellIndex] = {
                type: 'note',
                text: text
            };
            renderGrid();
            closeModal(modalNote);
        };
        document.getElementById('btn-note-cancel').onclick = () => closeModal(modalNote);

        // --- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è) ---
        document.getElementById('btn-reminder-save').onclick = () => {
            const text = document.getElementById('reminder-text').value;
            const time = document.getElementById('reminder-time').value; // 'YYYY-MM-DDTHH:mm'
            
            if (!text || !time) {
                tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ç–∞ —á–∞—Å.');
                return;
            }
            
            // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —á–∞—Å –≤ UTC ISO
            const localDate = new Date(time);
            const timeUTC = localDate.toISOString();

            gridState[currentCellIndex] = {
                type: 'reminder',
                text: text,
                time: timeUTC // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ UTC
            };
            renderGrid();
            closeModal(modalReminder);
        };
        document.getElementById('btn-reminder-cancel').onclick = () => closeModal(modalReminder);
        
        // --- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–ê—Ä—Ç) ---
        document.getElementById('btn-art-save').onclick = () => {
            const imageData = canvas.toDataURL('image/png'); // –û—Ç—Ä–∏–º—É—î–º–æ base64
            gridState[currentCellIndex] = {
                type: 'art',
                data: imageData // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ base64
            };
            renderGrid();
            closeModal(modalArt);
        };
        document.getElementById('btn-art-cancel').onclick = () => closeModal(modalArt);

        // ===================================
        // === –õ–û–ì–Ü–ö–ê –†–ï–î–ê–ö–¢–û–†–ê –ü–Ü–ö–°–ï–õ–¨-–ê–†–¢–£ ===
        // ===================================
        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let brushColor = '#FFF'; // –ë—ñ–ª–∏–π –º–∞—Ä–∫–µ—Ä
        let brushSize = 5; // –ú–∞–ª–µ–Ω—å–∫–∏–π
        
        const tools = {
            drawS: document.getElementById('tool-draw-s'),
            drawM: document.getElementById('tool-draw-m'),
            eraseS: document.getElementById('tool-erase-s'),
            eraseM: document.getElementById('tool-erase-m'),
        };

        function initCanvas() {
            ctx.fillStyle = '#000'; // –ß–æ—Ä–Ω–∏–π —Ñ–æ–Ω –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            setActiveTool('drawS');
        }
        
        function setActiveTool(toolKey) {
            Object.values(tools).forEach(t => t.classList.remove('active'));
            tools[toolKey].classList.add('active');
            
            if (toolKey === 'drawS') { brushColor = '#FFF'; brushSize = 5; }
            if (toolKey === 'drawM') { brushColor = '#FFF'; brushSize = 15; }
            if (toolKey === 'eraseS') { brushColor = '#000'; brushSize = 10; } // –ì—É–º–∫–∞ (S)
            if (toolKey === 'eraseM') { brushColor = '#000'; brushSize = 20; } // –ì—É–º–∫–∞ (M)
        }

        tools.drawS.onclick = () => setActiveTool('drawS');
        tools.drawM.onclick = () => setActiveTool('drawM');
        tools.eraseS.onclick = () => setActiveTool('eraseS');
        tools.eraseM.onclick = () => setActiveTool('eraseM');

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // –û–±—Ä–æ–±–∫–∞ –¥–æ—Ç–∏–∫—ñ–≤
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            ctx.fillStyle = brushColor;
            
            // –ú–∞–ª—é—î–º–æ –∫–≤–∞–¥—Ä–∞—Ç (–ø—ñ–∫—Å–µ–ª—å–Ω–∏–π —Å—Ç–∏–ª—å)
            ctx.fillRect(
                pos.x - Math.floor(brushSize / 2), 
                pos.y - Math.floor(brushSize / 2), 
                brushSize, 
                brushSize
            );
            e.preventDefault();
        }

        canvas.addEventListener('mousedown', (e) => { isDrawing = true; draw(e); });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mouseleave', () => { isDrawing = false; });
        
        // –î–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
        canvas.addEventListener('touchstart', (e) => { isDrawing = true; draw(e); }, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', () => { isDrawing = false; });

        // ===================================
        // === –í–Ü–î–ü–†–ê–í–ö–ê –î–ê–ù–ò–• –ë–û–¢–£ ===
        // ===================================
        
        tg.onEvent('mainButtonClicked', function() {
            // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
            const dataToSend = {
                grid: gridState
            };
            
            // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –¥–∞–Ω—ñ –±–æ—Ç—É
            tg.sendData(JSON.stringify(dataToSend));
            
            // WebApp –±—É–¥–µ –∑–∞–∫—Ä–∏—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, —è–∫—â–æ –±–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å
            // –ê–±–æ –º–æ–∂–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∏ –ø—Ä–∏–º—É—Å–æ–≤–æ:
            // tg.close();
        });

        // --- –ó–∞–ø—É—Å–∫ ---
        tg.ready();
        initApp();

    </script>
</body>
</html>