import os
import re
import json
import datetime
import base64
import io
from uuid import uuid4
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from telegram.ext import ContextTypes
from telegram.constants import ChatType, ParseMode
from PIL import Image
from dotenv import load_dotenv

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
if os.getenv("RENDER") != "true":
    load_dotenv()

RENDER_EXTERNAL_URL = os.getenv("RENDER_EXTERNAL_URL")

# --- –û–±—Ä–æ–±–Ω–∏–∫ –Ω–æ–≤–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ ---
async def handle_new_members(update: Update, context: ContextTypes.DEFAULT_TYPE):
    for member in update.message.new_chat_members:
        if not member.is_bot:
            
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª
            keyboard = [[InlineKeyboardButton("–ü–æ–∫–∞–∑–∞—Ç–∏ –ü—Ä–∞–≤–∏–ª–∞", callback_data="show_rules")]]
            reply_markup = InlineKeyboardMarkup(keyboard)

            welcome_message = (
                f"–ü—Ä–∏–≤—ñ—Ç, {member.full_name}! üëã\n"
                f"–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –Ω–∞—à–æ—ó —Å–ø—ñ–ª—å–Ω–æ—Ç–∏. \n"
                f"–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–∑–Ω–∞–π–æ–º—Ç–µ—Å—è –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏."
            )
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –≥—Ä—É–ø–∞ –∑ —Ç–µ–º–∞–º–∏ (—Ñ–æ—Ä—É–º)
            thread_id = update.message.message_thread_id if update.message.is_topic_message else None

            await update.message.reply_text(
                welcome_message,
                reply_markup=reply_markup,
                message_thread_id=thread_id
            )

# --- –û–±—Ä–æ–±–Ω–∏–∫ –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è ---
async def handle_join_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–∏–∫–ª–∞–¥: –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–ø–∏—Ç—É
    chat_id = update.chat.id
    user_id = update.from_user.id
    try:
        await context.bot.approve_chat_join_request(chat_id=chat_id, user_id=user_id)
        # –ú–æ–∂–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è
        # await context.bot.send_message(user_id, "–í–∞—à –∑–∞–ø–∏—Ç –Ω–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ —á–∞—Ç—É —Å—Ö–≤–∞–ª–µ–Ω–æ!")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É –Ω–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è: {e}")

# --- –û–±—Ä–æ–±–Ω–∏–∫ Callback Query (Inline –∫–Ω–æ–ø–∫–∏) ---
async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer() # –ó–∞–≤–∂–¥–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ –Ω–∞ query, —â–æ–± –ø—Ä–∏–±—Ä–∞—Ç–∏ "–≥–æ–¥–∏–Ω–Ω–∏–∫"

    if query.data == "show_rules":
        # –í—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞
        rules_text = (
            "üìú **–ü—Ä–∞–≤–∏–ª–∞ –ß–∞—Ç—É:**\n"
            "1. –ü–æ–≤–∞–∂–∞–π—Ç–µ —ñ–Ω—à–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤.\n"
            "2. –ù–µ —Å–ø–∞–º—Ç–µ —ñ –Ω–µ —Ñ–ª—É–¥—å—Ç–µ.\n"
            "3. –ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –æ–±—Ä–∞–∑–∏ —Ç–∞ –¥–∏—Å–∫—Ä–∏–º—ñ–Ω–∞—Ü—ñ—è.\n"
            "4. –í—Å—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è —Å–∏—Å—Ç–µ–º–æ—é Safe Browsing.\n"
            "5. –î–æ—Ç—Ä–∏–º—É–π—Ç–µ—Å—å –∑–∞–≥–∞–ª—å–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª Telegram.\n"
        )
        try:
             await query.edit_message_text(text=rules_text, parse_mode=ParseMode.MARKDOWN)
        except Exception:
             # –Ø–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ —Å—Ç–∞—Ä–µ, –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–æ–≤–µ
             await query.message.reply_text(rules_text, parse_mode=ParseMode.MARKDOWN)

# --- Drafts Web App ---

async def open_drafts_webapp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–ª—è—î –∫–æ–º–∞–Ω–¥—É /drafts, –≤—ñ–¥–∫—Ä–∏–≤–∞—é—á–∏ Web App."""
    if not RENDER_EXTERNAL_URL:
        await update.message.reply_text("–ü–æ–º–∏–ª–∫–∞: RENDER_EXTERNAL_URL –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
        return
        
    # –°—Ç–≤–æ—Ä—é—î–º–æ URL –¥–ª—è Web App
    webapp_url = f"{RENDER_EXTERNAL_URL.rstrip('/')}/drafts"
    
    keyboard = [[InlineKeyboardButton("‚úèÔ∏è –í—ñ–¥–∫—Ä–∏—Ç–∏ –ß–µ—Ä–Ω–µ—Ç–∫–∏", web_app=WebAppInfo(url=webapp_url))]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É —Å—ñ—Ç–∫—É —á–µ—Ä–Ω–µ—Ç–æ–∫:",
        reply_markup=reply_markup,
        message_thread_id=update.message.message_thread_id
    )

# --- Job –¥–ª—è –ù–∞–≥–∞–¥—É–≤–∞–Ω—å ---

async def send_reminder_job(context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞–¥—Å–∏–ª–∞—î –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É."""
    job = context.job
    chat_id = job.data.get('chat_id')
    text = job.data.get('text')
    
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ MarkdownV2 –¥–ª—è –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É
    try:
        # –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –¥–ª—è MarkdownV2
        escaped_text = re.sub(r'([_*\[\]()~`>#+\-=|{}.!])', r'\\\1', text)
        
        await context.bot.send_message(
            chat_id=chat_id, 
            text=f"‚è∞ **–ù–ê–ì–ê–î–£–í–ê–ù–ù–Ø:**\\n\\n`{escaped_text}`", 
            parse_mode=ParseMode.MARKDOWN_V2
        )
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è {chat_id}: {e}")

# --- –û–±—Ä–æ–±–∫–∞ Web App Data ---

async def handle_webapp_data(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–ª—è—î JSON –¥–∞–Ω—ñ, –æ—Ç—Ä–∏–º–∞–Ω—ñ –∑ Web App (drafts.html)."""
    
    user_data_string = update.message.web_app_data.data
    chat_id = update.effective_chat.id
    user = update.effective_user
    job_queue = context.application.job_queue # –û—Ç—Ä–∏–º—É—î–º–æ job_queue –∑ context
    
    notes_saved = 0
    arts_saved = 0
    reminders_set = 0
    
    try:
        data = json.loads(user_data_string)
        
        # 1. –û–±—Ä–æ–±–∫–∞ –ù–æ—Ç–∞—Ç–æ–∫/–ù–∞–≥–∞–¥—É–≤–∞–Ω—å
        if 'notes' in data and isinstance(data['notes'], list):
            for item in data['notes']:
                text = item.get('text', '').strip()
                reminder = item.get('reminder') # ISO 8601 UTC string
                
                if text:
                    notes_saved += 1
                    
                    # 2. –û–±—Ä–æ–±–∫–∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω—å
                    if reminder:
                        try:
                            # –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è ISO UTC –Ω–∞ –æ–±'—î–∫—Ç datetime
                            reminder_time_utc = datetime.datetime.fromisoformat(reminder.replace('Z', '+00:00'))
                            
                            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —á–∞—Å —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É
                            if reminder_time_utc > datetime.datetime.now(datetime.timezone.utc):
                                
                                # –°—Ç–≤–æ—Ä—é—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–µ —ñ–º'—è –¥–ª—è –∑–∞–≤–¥–∞–Ω–Ω—è
                                job_name = f"reminder_user_{user.id}_{uuid4()}"
                                
                                # –ü–ª–∞–Ω—É—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è
                                job_queue.run_once(
                                    send_reminder_job,
                                    reminder_time_utc, # –ß–∞—Å —É UTC
                                    data={'chat_id': chat_id, 'text': text},
                                    name=job_name
                                )
                                reminders_set += 1
                            
                        except (ValueError, TypeError) as e:
                            print(f"–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —á–∞—Å—É –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è: {e}")

        # 3. –û–±—Ä–æ–±–∫–∞ –ê—Ä—Ç—ñ–≤
        if 'arts' in data and isinstance(data['arts'], list):
            for item in data['arts']:
                base64_image = item.get('image')
                
                if base64_image:
                    try:
                        # –î–µ–∫–æ–¥—É—î–º–æ Base64
                        image_data = base64.b64decode(base64_image)
                        image_stream = io.BytesIO(image_data)
                        
                        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ): —á–∏ —Ü–µ –¥—ñ–π—Å–Ω–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                        Image.open(image_stream) 
                        
                        # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —è–∫ —Ñ–æ—Ç–æ
                        image_stream.seek(0)
                        await context.bot.send_photo(
                            chat_id=chat_id,
                            photo=image_stream,
                            caption="üñºÔ∏è –ó–±–µ—Ä–µ–∂–µ–Ω–∏–π Pixel Art",
                        )
                        arts_saved += 1
                        
                    except Exception as e:
                        print(f"–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∞—Ä—Ç—É: {e}")


        # –í—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        await update.message.reply_text(
            f"‚úÖ –î–∞–Ω—ñ –∑ Drafts –∑–±–µ—Ä–µ–∂–µ–Ω–æ!\n"
            f"–ù–æ—Ç–∞—Ç–æ–∫: {notes_saved}\n"
            f"–ê—Ä—Ç—ñ–≤: {arts_saved}\n"
            f"–ù–∞–≥–∞–¥—É–≤–∞–Ω—å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {reminders_set}",
            # –ü—Ä–∏–º—ñ—Ç–∫–∞: MarkdownV2 —Ç—É—Ç –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω, –æ—Å–∫—ñ–ª—å–∫–∏ –º–∏ –Ω–µ –µ–∫—Ä–∞–Ω—É—î–º–æ —Ç–µ–∫—Å—Ç.
        )
        
        # –ó–∞–∫—Ä–∏–≤–∞—î–º–æ Web App –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, –∞–ª–µ –∫–æ—Ä–∏—Å–Ω–æ)
        # try:
        #     await context.bot.answer_web_app_query(
        #         web_app_query_id=update.message.web_app_data.id, 
        #         result=InlineQueryResultArticle(
        #             id=str(uuid4()),
        #             title="–ó–±–µ—Ä–µ–∂–µ–Ω–æ",
        #             input_message_content=InputTextMessageContent("–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ –±–æ—Ç–æ–º.")
        #         )
        #     )
        # except Exception:
        #     pass


    except json.JSONDecodeError:
        await update.message.reply_text("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö –∑ Web App.")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –≤ handle_webapp_data: {e}")
        await update.message.reply_text(f"–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞: {e}")

# –§—É–Ω–∫—Ü—ñ—ó handle_webapp_data —Ç–∞ send_reminder_job –≥–∞—Ä–∞–Ω—Ç—É—é—Ç—å, —â–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–∏–π–¥—É—Ç—å,
# –∞ –∞—Ä—Ç –±—É–¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —è–∫ —Ñ–æ—Ç–æ, —è–∫ —Ç—ñ–ª—å–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –¥–∞–Ω—ñ.