drafts.html
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MORSTRIX | DRAFTZ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –†–ï–¢–†–û –°–¢–ò–õ–¨ --- */
        :root {
            --bg-color: #000000;
            --main-green: #00ff00; /* –Ø—Ä–∫–∏–π —Ç–µ–∫—Å—Ç */
            --dark-green: #008000; /* –¢–µ–º–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç */
            --red-exit: #ff0000;
            --grid-color: #111111;
            --canvas-bg: #222222; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ö–æ–ª—Å—Ç */
            --cell-size: 15px;
            --input-bg: #0d0d0d;
        }

        body {
            font-family: monospace; /* –†–µ—Ç—Ä–æ-—à—Ä–∏—Ñ—Ç (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ Press Start 2P, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) */
            background-color: var(--bg-color);
            color: var(--main-green);
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            touch-action: pan-y;
            image-rendering: pixelated;
        }

        /* --- –ö–Ω–æ–ø–∫–∏ –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ --- */
        .header-title {
            text-align: center;
            font-size: 20px;
            padding-bottom: 15px;
            text-shadow: 0 0 5px var(--main-green);
        }

        .action-button, .item-button {
            display: block;
            width: 100%;
            background-color: var(--dark-green);
            color: var(--bg-color);
            border: 2px solid var(--main-green);
            padding: 15px 10px;
            margin-bottom: 10px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 14px;
            text-align: left;
            box-shadow: 0 0 5px var(--dark-green);
            transition: background-color 0.1s;
        }
        .action-button:hover, .item-button:hover {
            background-color: var(--main-green);
            color: var(--bg-color);
        }
        .item-button span {
            float: right;
            color: var(--main-green);
        }
        
        .item-button:hover span {
            color: var(--bg-color);
        }

        /* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –í—å—é—à–µ–∫ --- */
        .view {
            display: none;
            padding-bottom: 50px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è MainButton */
        }
        .view.active {
            display: block;
        }

        /* --- –ö–Ω–æ–ø–∫–∞ –í—ã—Ö–æ–¥–∞ (–ò–º–∏—Ç–∞—Ü–∏—è –∫—Ä–µ—Å—Ç–∏–∫–∞) --- */
        #exit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--red-exit);
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            text-shadow: 0 0 5px var(--red-exit);
        }

        /* --- –ü–æ–ª—è –í–≤–æ–¥–∞ --- */
        input[type="text"], input[type="datetime-local"], textarea {
            width: 95%;
            padding: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--dark-green);
            color: var(--main-green);
            font-size: 16px;
            margin-bottom: 10px;
            resize: none;
        }
        
        /* --- Pixel Art Editor --- */
        #art-canvas-container {
            width: 100%;
            max-width: 450px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
            margin: 0 auto 10px;
            background-color: var(--canvas-bg);
            border: 2px solid var(--main-green);
            overflow: hidden;
            touch-action: none;
        }
        #pixel-canvas {
            display: block;
            touch-action: none;
            cursor: crosshair;
        }
        .art-controls {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .art-controls button {
            background-color: #333;
            color: var(--main-green);
            border: 1px solid var(--main-green);
            padding: 8px 12px;
            margin: 5px;
            font-size: 12px;
        }
        #color-picker {
            border: 1px solid var(--main-green);
            padding: 0;
            height: 30px;
            width: 30px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="exit-btn" onclick="goBackOrClose()">‚ùå</div>

    <div id="catalog-list-view" class="view active">
        <div class="header-title">DRAFTZ / CATALOGS</div>
        <div id="catalogs-container">
            </div>
        <button class="action-button" onclick="showCatalogCreator()">+ –°–¢–í–û–†–ò–¢–ò –ö–ê–¢–ê–õ–û–ì</button>
    </div>

    <div id="item-list-view" class="view">
        <div class="header-title" id="item-list-title"></div>
        <div id="items-container">
            </div>
        <button class="action-button" onclick="showItemCreator()">+ –°–¢–í–û–†–ò–¢–ò –ï–õ–ï–ú–ï–ù–¢</button>
    </div>
    
    <div id="catalog-editor-view" class="view">
        <div class="header-title">–ö–ê–¢–ê–õ–û–ì / –°–¢–í–û–†–ï–ù–ù–Ø</div>
        <input type="text" id="catalog-name-input" placeholder="–ù–∞–∑–≤–∞ –ö–∞—Ç–∞–ª–æ–≥—É">
    </div>

    <div id="item-creator-view" class="view">
        <div class="header-title">–û–ë–ï–†–ò –¢–ò–ü –ï–õ–ï–ú–ï–ù–¢–ê</div>
        <button class="action-button" onclick="showNoteEditor()">üìù –ù–û–í–ê –ó–ê–ú–Ü–¢–ö–ê</button>
        <button class="action-button" onclick="showPushEditor()">‚è∞ –ù–û–í–ï –ù–ê–ì–ê–î–£–í–ê–ù–ù–Ø</button>
        <button class="action-button" onclick="showArtEditor()">üé® –ù–û–í–ò–ô –ê–†–¢</button>
    </div>


    <div id="note-editor-view" class="view">
        <div class="header-title">–ó–ê–ú–Ü–¢–ö–ê / –†–ï–î–ê–ö–¢–û–†</div>
        <input type="text" id="note-name-input" placeholder="–ù–∞–∑–≤–∞ –ó–∞–º—ñ—Ç–∫–∏">
        <textarea id="note-text-input" rows="10" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º—ñ—Ç–∫–∏..."></textarea>
    </div>

    <div id="push-editor-view" class="view">
        <div class="header-title">–ù–ê–ì–ê–î–£–í–ê–ù–ù–Ø / –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø</div>
        <input type="text" id="push-name-input" placeholder="–ù–∞–∑–≤–∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è">
        <p>–î–∞—Ç–∞ —ñ –ß–∞—Å (–í–∞—à –ª–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å):</p>
        <input type="datetime-local" id="push-datetime-input">
        <textarea id="push-text-input" rows="4" placeholder="–¢–µ–∫—Å—Ç –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è..."></textarea>
    </div>

    <div id="art-editor-view" class="view">
        <div class="header-title">–ü–Ü–ö–°–ï–õ–¨–ù–ò–ô –ê–†–¢ / –†–ï–î–ê–ö–¢–û–†</div>
        <input type="text" id="art-name-input" placeholder="–ù–∞–∑–≤–∞ –ê—Ä—Ç—É">
        
        <div id="art-canvas-container">
            <canvas id="pixel-canvas"></canvas>
        </div>

        <div class="art-controls">
            <input type="color" id="color-picker" value="#ffffff" title="–ö–æ–ª—ñ—Ä">
            <button id="toggle-tool-btn" data-tool="pen">‚úèÔ∏è –ö–∏—Å—Ç—å</button>
            <button id="clear-art-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
            <button id="send-art-btn">üì® –ù–ê–î–Ü–°–õ–ê–¢–ò</button>
        </div>
    </div>


    <script>
        // --- –ö–û–ù–°–¢–ê–ù–¢–ò ---
        const WebApp = window.Telegram.WebApp;
        const GRID_DIMENSION = 20; 
        const CELL_SIZE = 15; 
        const CANVAS_WIDTH = GRID_DIMENSION * CELL_SIZE;
        const CANVAS_HEIGHT = GRID_DIMENSION * CELL_SIZE;
        
        // --- –°–¢–ê–ù –î–û–î–ê–¢–ö–£ ---
        let currentView = 'catalog-list-view';
        let viewHistory = [];
        let dataStore = JSON.parse(localStorage.getItem('draftsData') || '{"catalogs": {}}');
        let currentCatalogId = null;
        let currentItemId = null;
        let currentItemType = null; // 'note', 'push', 'art'
        
        // --- PIXEL ART –°–¢–ê–ù ---
        let canvas, ctx, colorPicker, toggleToolBtn, clearArtBtn, sendArtBtn;
        let pixelGrid;
        let isDrawing = false;
        let currentDrawColor = '#ffffff';
        let currentTool = 'pen'; 
        
        // --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ---

        function initApp() {
            if (WebApp) {
                WebApp.ready();
                WebApp.setHeaderColor(WebApp.themeParams.bg_color);
                WebApp.onEvent('backButtonClicked', goBackOrClose);
            }
            
            // Art-—Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è, —è–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ DOM
            initArtEditor();
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–∞—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            const now = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000));
            document.getElementById('push-datetime-input').min = now.toISOString().slice(0, 16);
            
            showView('catalog-list-view');
            
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è MainButton
            WebApp.MainButton.setText("ENTER [–°–û–•–†–ê–ù–ò–¢–¨]");
            WebApp.MainButton.onClick(handleMainButtonClick);
            WebApp.MainButton.hide();

            // üí• –§–ò–ö–° 1: –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ê–í–ò–®–ò ENTER –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ö–ê–¢–ê–õ–û–ì–ê üí•
            const catalogInput = document.getElementById('catalog-name-input');
            if (catalogInput) {
                catalogInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' || event.keyCode === 13) {
                        event.preventDefault(); 
                        saveCatalog(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞
                    }
                });
            }
             
            // üí• –§–ò–ö–° 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è sendArtBtn (–¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–∫–∏ ReferenceError) üí•
            sendArtBtn = document.getElementById('send-art-btn');
            if (sendArtBtn) {
                 sendArtBtn.addEventListener('click', sendArt);
            }
        }

        function saveStore() {
            localStorage.setItem('draftsData', JSON.stringify(dataStore));
        }

        // --- –õ–û–ì–Ü–ö–ê –ù–ê–í–Ü–ì–ê–¶–Ü–á ---

        function updateMainButton(isVisible, text = "ENTER [–°–û–•–†–ê–ù–ò–¢–¨]", color = WebApp.themeParams.button_color) {
            if (!WebApp) return;
            WebApp.MainButton.setText(text);
            WebApp.MainButton.setParams({color: color});
            isVisible ? WebApp.MainButton.show() : WebApp.MainButton.hide();
        }

        function updateBackButton(isVisible) {
             if (!WebApp) return;
             isVisible ? WebApp.BackButton.show() : WebApp.BackButton.hide();
        }

        function showView(viewId, isNewContext = true) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            if (isNewContext && viewId !== currentView) {
                viewHistory.push(currentView);
            }
            currentView = viewId;
            
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ view
            let buttonVisible = false;
            let backVisible = true;
            
            if (viewId === 'catalog-list-view') {
                 backVisible = false;
                 updateCatalogList();
            } else if (viewId.includes('editor-view')) {
                 buttonVisible = true;
            } else if (viewId === 'item-list-view') {
                 updateItemList();
            }
            
            updateMainButton(buttonVisible);
            updateBackButton(backVisible);
            
            // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤
            if (viewId === 'art-editor-view') {
                loadArt(currentItemId);
                redrawCanvas();
            } else if (viewId === 'push-editor-view') {
                 // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ, —è–∫—â–æ —Ü–µ –Ω–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç
                 const pushDateTime = document.getElementById('push-datetime-input');
                 if (!currentItemId) {
                    pushDateTime.value = pushDateTime.min;
                 }
            }
        }
        
        function goBackOrClose() {
            if (viewHistory.length > 0) {
                const prevView = viewHistory.pop();
                showView(prevView, false); // false - —â–æ–± –Ω–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –≤ —ñ—Å—Ç–æ—Ä—ñ—é
            } else {
                if (WebApp) {
                    WebApp.close();
                } else {
                    alert("–ó–∞–∫—Ä–∏—Ç—Ç—è Web App (–≤ —Ä–µ–∂–∏–º—ñ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è)");
                }
            }
        }
        
        // --- –õ–û–ì–Ü–ö–ê –°–ü–ò–°–ö–Ü–í (–ö–ê–¢–ê–õ–û–ì–ò/–ï–õ–ï–ú–ï–ù–¢–ò) ---
        
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function updateCatalogList() {
            const container = document.getElementById('catalogs-container');
            container.innerHTML = '';
            
            Object.entries(dataStore.catalogs).forEach(([id, catalog]) => {
                const btn = document.createElement('button');
                btn.className = 'item-button';
                btn.innerHTML = `${catalog.name} <span>${Object.keys(catalog.items).length}</span>`;
                btn.onclick = () => openCatalog(id);
                container.appendChild(btn);
            });
        }
        
        function updateItemList() {
            if (!currentCatalogId) return goBackOrClose();

            const catalog = dataStore.catalogs[currentCatalogId];
            document.getElementById('item-list-title').textContent = `DRAFTZ / ${catalog.name.toUpperCase()}`;
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            Object.entries(catalog.items).forEach(([itemId, item]) => {
                const btn = document.createElement('button');
                btn.className = 'item-button';
                let typeIcon = '';
                if (item.type === 'note') typeIcon = 'üìù';
                if (item.type === 'push') typeIcon = '‚è∞';
                if (item.type === 'art') typeIcon = 'üé®';
                
                btn.innerHTML = `${typeIcon} ${item.name} <span>EDIT</span>`;
                btn.onclick = () => openItem(itemId, item.type);
                container.appendChild(btn);
            });
        }
        
        function openCatalog(id) {
            currentCatalogId = id;
            currentItemId = null;
            currentItemType = null;
            showView('item-list-view');
        }

        function openItem(id, type) {
            currentItemId = id;
            currentItemType = type;
            const item = dataStore.catalogs[currentCatalogId].items[id];
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∏
            if (type === 'note') {
                document.getElementById('note-name-input').value = item.name;
                document.getElementById('note-text-input').value = item.text || '';
                showView('note-editor-view');
            } else if (type === 'push') {
                document.getElementById('push-name-input').value = item.name;
                document.getElementById('push-datetime-input').value = item.datetime || '';
                document.getElementById('push-text-input').value = item.text || '';
                showView('push-editor-view');
            } else if (type === 'art') {
                document.getElementById('art-name-input').value = item.name;
                showView('art-editor-view');
            }
        }

        // --- –õ–û–ì–Ü–ö–ê –°–¢–í–û–†–ï–ù–ù–Ø ---
        
        function showCatalogCreator() {
            currentItemId = null; 
            document.getElementById('catalog-name-input').value = '';
            showView('catalog-editor-view');
        }

        function showItemCreator() {
            currentItemId = null; 
            currentItemType = null;
            showView('item-creator-view');
        }

        function showNoteEditor() {
            currentItemType = 'note';
            showView('note-editor-view');
        }
        
        function showPushEditor() {
            currentItemType = 'push';
            showView('push-editor-view');
        }

        function showArtEditor() {
            currentItemType = 'art';
            // –Ø–∫—â–æ —Ü–µ –Ω–æ–≤–∏–π –∞—Ä—Ç, —Å–∫–∏–¥–∞—î–º–æ –Ω–∞–∑–≤—É —ñ —Å—ñ—Ç–∫—É
            if (!currentItemId) {
                document.getElementById('art-name-input').value = '–ù–æ–≤–∏–π –ê—Ä—Ç';
                initPixelGrid(); 
            }
            showView('art-editor-view');
        }

        // --- –õ–û–ì–Ü–ö–ê –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø (MainButton Click) ---

        function handleMainButtonClick() {
            if (currentView === 'catalog-editor-view') {
                saveCatalog();
            } else if (currentView === 'note-editor-view') {
                saveNote();
            } else if (currentView === 'push-editor-view') {
                savePush();
            } else if (currentView === 'art-editor-view') {
                saveArtItem();
            }
        }

        function saveCatalog() {
            const name = document.getElementById('catalog-name-input').value.trim() || "–ù–æ–≤–∏–π –ö–∞—Ç–∞–ª–æ–≥";
            const id = currentItemId || generateUniqueId();
            
            if (!dataStore.catalogs[id]) {
                dataStore.catalogs[id] = {id: id, name: name, items: {}};
            } else {
                dataStore.catalogs[id].name = name;
            }
            saveStore();
            showView('catalog-list-view');
        }
        
        function saveItem(type) {
            const id = currentItemId || generateUniqueId();
            const catalog = dataStore.catalogs[currentCatalogId];
            
            let name, data;
            
            if (type === 'note') {
                name = document.getElementById('note-name-input').value.trim() || "–ù–æ–≤–∞ –ó–∞–º—ñ—Ç–∫–∞";
                data = {
                    text: document.getElementById('note-text-input').value,
                };
            } else if (type === 'push') {
                name = document.getElementById('push-name-input').value.trim() || "–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è";
                data = {
                    datetime: document.getElementById('push-datetime-input').value,
                    text: document.getElementById('push-text-input').value,
                };
            } else if (type === 'art') {
                name = document.getElementById('art-name-input').value.trim() || "–ü—ñ–∫—Å–µ–ª—å–Ω–∏–π –ê—Ä—Ç";
                // Art data is already saved in pixelGrid/localStorage
                data = {}; 
            }
            
            catalog.items[id] = {
                id: id,
                type: type,
                name: name,
                ...data
            };
            saveStore();
            currentItemId = id; // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ ID, —â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏
        }

        function saveNote() {
            saveItem('note');
            showView('item-list-view');
        }
        
        function savePush() {
            saveItem('push');
            showView('item-list-view');
        }

        function saveArtItem() {
            saveItem('art');
            showView('item-list-view');
        }
        
        // --- –õ–û–ì–Ü–ö–ê –í–Ü–î–ü–†–ê–í–ö–ò (–¢—ñ–ª—å–∫–∏ –¥–ª—è –ê—Ä—Ç—É/–ü—É—à–∞) ---
        
        // sendArtBtn.addEventListener('click', sendArt); // ‚ùå –ü–û–ú–ò–õ–ö–ê: sendArtBtn –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Ç—É—Ç

        function sendArt() {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Å—Ç–∞–Ω
            saveArtItem(); 
            
            if (!currentItemId) return alert("–°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –∞—Ä—Ç.");

            const artData = localStorage.getItem(`morstrix_art_${currentItemId}`);
            if (!artData) return alert("–ê—Ä—Ç –ø—É—Å—Ç–∏–π.");
            
            const name = dataStore.catalogs[currentCatalogId].items[currentItemId].name;

            // –§–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö: "ART|CATALOG_ID_ITEM_ID|JSON_PAYLOAD"
            const data = `ART|${currentCatalogId}_${currentItemId}|${artData}`;

            if (WebApp) {
                WebApp.sendData(data);
                WebApp.close();
            } else {
                alert(`ART Data Sent (debug): ${data.substring(0, 100)}...`);
            }
        }
        
        // --- –õ–û–ì–Ü–ö–ê PIXEL ART ---

        function initArtEditor() {
            canvas = document.getElementById('pixel-canvas');
            ctx = canvas.getContext('2d');
            colorPicker = document.getElementById('color-picker');
            toggleToolBtn = document.getElementById('toggle-tool-btn');
            clearArtBtn = document.getElementById('clear-art-btn');
            // sendArtBtn = document.getElementById('send-art-btn'); // ‚úÖ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ initApp

            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
            
            initPixelGrid();

            // –û–±—Ä–æ–±–Ω–∏–∫–∏
            canvas.addEventListener('mousedown', handlePointerStart);
            canvas.addEventListener('mousemove', handlePointerMove);
            document.addEventListener('mouseup', handlePointerEnd);
            canvas.addEventListener('touchstart', handlePointerStart);
            canvas.addEventListener('touchmove', handlePointerMove);
            canvas.addEventListener('touchend', handlePointerEnd);
            colorPicker.addEventListener('input', (e) => { currentDrawColor = e.target.value; if (currentTool === 'eraser') toggleTool(); });
            toggleToolBtn.addEventListener('click', toggleTool);
            clearArtBtn.addEventListener('click', () => { if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏?")) { initPixelGrid(); redrawCanvas(); saveArt(currentItemId); } });
        }
        
        function initPixelGrid() {
            pixelGrid = Array(GRID_DIMENSION).fill(0).map(() => Array(GRID_DIMENSION).fill(null));
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            // 1. –ú–∞–ª—é—î–º–æ –ø—ñ–∫—Å–µ–ª—ñ
            for (let y = 0; y < GRID_DIMENSION; y++) {
                for (let x = 0; x < GRID_DIMENSION; x++) {
                    const color = pixelGrid[y][x];
                    if (color) {
                        ctx.fillStyle = color;
                        ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }

            // 2. –ú–∞–ª—é—î–º–æ —Å—ñ—Ç–∫—É (—Ç–µ–º–Ω–æ-—Å—ñ—Ä–∞, —è–∫ —Ñ–æ–Ω —Ö–æ–ª—Å—Ç–∞)
            ctx.strokeStyle = '#2d2d2d'; 
            ctx.lineWidth = 1;
            for (let i = 0; i <= GRID_DIMENSION; i++) {
                ctx.beginPath();
                ctx.moveTo(i * CELL_SIZE, 0);
                ctx.lineTo(i * CELL_SIZE, CANVAS_HEIGHT);
                ctx.moveTo(0, i * CELL_SIZE);
                ctx.lineTo(CANVAS_WIDTH, i * CELL_SIZE);
                ctx.stroke();
            }
        }

        function getMousePos(event) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            const containerScrollX = window.scrollX || document.documentElement.scrollLeft;
            const containerScrollY = window.scrollY || document.documentElement.scrollTop;

            if (event.touches) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            
            const x = clientX - rect.left - containerScrollX;
            const y = clientY - rect.top - containerScrollY;

            return {
                x: Math.floor(x / CELL_SIZE),
                y: Math.floor(y / CELL_SIZE)
            };
        }
        
        let lastX = -1, lastY = -1;

        function drawPixel(x, y) {
            if (x >= 0 && x < GRID_DIMENSION && y >= 0 && y < GRID_DIMENSION) {
                if (x === lastX && y === lastY) return; 
                
                const color = currentTool === 'pen' ? currentDrawColor : null; // null = erase
                pixelGrid[y][x] = color;
                redrawCanvas();
                saveArt(currentItemId); 
                
                lastX = x;
                lastY = y;
            }
        }

        function handlePointerStart(event) {
            event.preventDefault(); 
            isDrawing = true;
            const pos = getMousePos(event);
            lastX = -1; lastY = -1; 
            drawPixel(pos.x, pos.y);
        }

        function handlePointerMove(event) {
            if (!isDrawing) return;
            event.preventDefault();
            const pos = getMousePos(event);
            drawPixel(pos.x, pos.y);
        }

        function handlePointerEnd(event) {
            isDrawing = false;
            lastX = -1; lastY = -1; 
        }

        function toggleTool() {
            if (currentTool === 'pen') {
                currentTool = 'eraser';
                toggleToolBtn.innerHTML = 'üßº –õ–∞—Å—Ç–∏–∫';
            } else {
                currentTool = 'pen';
                toggleToolBtn.innerHTML = '‚úèÔ∏è –ö–∏—Å—Ç—å';
            }
        }

        function saveArt(key) {
            if (key) {
                localStorage.setItem(`morstrix_art_${key}`, JSON.stringify(pixelGrid));
            }
        }

        function loadArt(key) {
            if (!key) return initPixelGrid();
            
            try {
                const savedData = localStorage.getItem(`morstrix_art_${key}`);
                if (savedData) {
                    pixelGrid = JSON.parse(savedData);
                } else {
                    initPixelGrid(); 
                }
            } catch (e) {
                initPixelGrid(); 
            }
        }


        // --- –ó–ê–ü–£–°–ö ---
        window.addEventListener('load', initApp);
    </script>
</body>
</html>