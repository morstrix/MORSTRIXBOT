drafts.html
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORSTRIX | –ê—Ä—Ö—ñ–≤ (Pixel Art)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #000000; /* –ß–æ—Ä–Ω–∏–π —Ñ–æ–Ω */
            --grid-color: #004d40; /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω–∏–π –¥–ª—è —Å—ñ—Ç–∫–∏ */
            --text-color: #00ff00; /* –Ø—Å–∫—Ä–∞–≤–æ-–∑–µ–ª–µ–Ω–∏–π –¥–ª—è —Ç–µ–∫—Å—Ç—É (Pixel) */
            --accent-color: #ff00ff; /* –ú–∞–¥–∂–µ–Ω—Ç–∞ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç—É (Retro) */
            --cell-size: 80px;
            --draw-color: var(--text-color); /* –ö–æ–ª—ñ—Ä –º–∞–ª—é–≤–∞–Ω–Ω—è */
            --erase-color: var(--bg-color); /* –ö–æ–ª—ñ—Ä —Å—Ç–∏—Ä–∞–Ω–Ω—è */
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            touch-action: pan-y;
            image-rendering: pixelated;
        }
        
        @supports not (font-family: 'Press Start 2P') {
             body {
                font-family: monospace;
            }
        }

        .header {
            /* ... (–°—Ç–∏–ª—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            text-align: center;
            padding: 10px;
            background-color: var(--grid-color);
            color: #fff;
            box-shadow: 0 4px 0 var(--accent-color);
            margin-bottom: 5px;
            text-shadow: 2px 2px 0 #000;
        }

        .grid-container {
            /* 4 –ö–û–õ–û–ù–ö–ò */
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 1px; 
            padding: 10px;
            background-color: var(--grid-color); 
        }

        .cell {
             /* ... (–°—Ç–∏–ª—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Å—ñ—Ç–∫–∏ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            min-height: var(--cell-size);
            background-color: var(--bg-color);
            border: 1px solid var(--grid-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.1s;
            text-align: center;
            padding: 5px;
            font-size: 10px;
        }

        .cell:hover {
            background-color: #001a14;
        }

        .note-indicator {
            color: var(--accent-color);
            font-size: 14px;
            text-shadow: 1px 1px 0 #000;
            margin-top: 5px;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
        .modal {
            /* ... (–°—Ç–∏–ª—ñ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98); 
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            /* ... (–°—Ç–∏–ª—ñ –≤–º—ñ—Å—Ç—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            width: 95%;
            max-width: 600px;
            height: 80vh; 
            background: var(--bg-color);
            border: 2px solid var(--text-color);
            padding: 20px;
            box-shadow: 4px 4px 0 var(--accent-color);
            display: flex;
            flex-direction: column;
        }
        
        /* –¢–ê–ë–ò */
        .tab-controls {
            display: flex;
            margin-bottom: 15px;
        }

        .tab-btn {
            background-color: var(--grid-color);
            color: #fff;
            border: 2px solid var(--grid-color);
            padding: 8px 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            box-shadow: 2px 2px 0 #000;
            flex-grow: 1;
            margin: 0 5px;
        }

        .tab-btn.active {
            background-color: var(--text-color);
            color: var(--bg-color);
            border-color: var(--text-color);
        }
        
        .tab-content {
            flex-grow: 1;
            overflow-y: hidden; /* –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –∫–µ—Ä—É—î —Å–≤–æ—ó–º –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—è–º */
            display: none;
            padding: 10px 0;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–µ–∫—Ü—ñ—ó "–ù–æ—Ç–∞—Ç–∫–∏" */
        .note-list-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--grid-color);
            margin-bottom: 10px;
            padding: 10px;
            background-color: #000000;
        }

        .note-item {
             /* ... (–°—Ç–∏–ª—ñ –µ–ª–µ–º–µ–Ω—Ç–∞ –Ω–æ—Ç–∞—Ç–∫–∏ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px dotted var(--text-color);
            font-size: 14px;
            word-break: break-all;
            white-space: pre-wrap;
        }
        
        textarea {
            /* ... (–°—Ç–∏–ª—ñ textarea –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            width: 100%;
            height: 100px;
            background-color: #000000;
            color: var(--text-color);
            border: 1px solid var(--grid-color);
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .add-note-btn {
             /* ... (–°—Ç–∏–ª—ñ –∫–Ω–æ–ø–∫–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ—Ç–∞—Ç–∫–∏ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            background-color: #004d40;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            box-shadow: 1px 1px 0 #000;
            margin-bottom: 10px;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–µ–∫—Ü—ñ—ó "–ê—Ä—Ç" */
        #art-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        
        #pixel-canvas {
            border: 2px solid var(--text-color);
            box-shadow: 4px 4px 0 var(--accent-color);
            image-rendering: pixelated;
            touch-action: none; /* –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Å–∫—Ä–æ–ª –Ω–∞ –∫–∞–Ω–≤–∞—Å—ñ */
        }
        
        .art-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .art-btn {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            box-shadow: 2px 2px 0 #000;
        }

        .button-group {
             /* ... (–°—Ç–∏–ª—ñ –≥—Ä—É–ø–∏ –∫–Ω–æ–ø–æ–∫ –Ω–µ –∑–º—ñ–Ω–µ–Ω—ñ) ... */
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: auto;
        }

    </style>
</head>
<body>

    <div class="header">
        MORSTRIX ARCHIVE V2.1
    </div>

    <div id="grid-container" class="grid-container">
        </div>

    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–ö—ñ–º–Ω–∞—Ç–∞ [X, Y]</h2>
            
            <div class="tab-controls">
                <button id="tabNotesBtn" class="tab-btn active">–ù–û–¢–ê–¢–ö–ò</button>
                <button id="tabArtBtn" class="tab-btn">–ê–†–¢ (8x8)</button>
            </div>
            
            <div id="notesTab" class="tab-content active">
                <div id="noteListContainer" class="note-list-container">
                    </div>
                
                <textarea id="noteContent" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É –Ω–æ—Ç–∞—Ç–∫—É (–æ–¥–∏–Ω –∑–∞–ø–∏—Å)..."></textarea>
                <button id="addNoteBtn" class="add-note-btn">–î–û–î–ê–¢–ò –ù–û–¢–ê–¢–ö–£</button>
            </div>
            
            <div id="artTab" class="tab-content">
                <div id="art-container">
                    <canvas id="pixel-canvas" width="256" height="256"></canvas>
                    <div class="art-controls">
                        <button id="clearArtBtn" class="art-btn">–û–ß–ò–°–¢–ò–¢–ò</button>
                        <button id="toggleColorBtn" class="art-btn">–ö–û–õ–Ü–†: <span id="currentColorIndicator" style="color: var(--draw-color);">**–Ø–°–ö–†–ê–í–ò–ô**</span></button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button id="saveNoteBtn" class="save-btn">–ó–ë–ï–†–ï–ì–¢–ò –í–°–ï</button>
                <button id="sendNoteBtn" class="send-btn">–ù–ê–î–Ü–°–õ–ê–¢–ò</button>
                <button id="closeModalBtn" class="close-btn">–ó–ê–ö–†–ò–¢–ò</button>
            </div>
        </div>
    </div>

    <script>
        const GRID_ROWS = 7;
        const GRID_COLS = 4;
        const ART_GRID_SIZE = 8; // 8x8 –ø—ñ–∫—Å–µ–ª—ñ–≤
        const PIXEL_SIZE = 256 / ART_GRID_SIZE; // –†–æ–∑–º—ñ—Ä –∫–ª—ñ—Ç–∏–Ω–∫–∏ –Ω–∞ Canvas (256x256 / 8 = 32)

        const gridContainer = document.getElementById('grid-container');
        const noteModal = document.getElementById('noteModal');
        const modalTitle = document.getElementById('modalTitle');
        const noteContentInput = document.getElementById('noteContent'); 
        const noteListContainer = document.getElementById('noteListContainer'); 
        const addNoteBtn = document.getElementById('addNoteBtn'); 
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const sendNoteBtn = document.getElementById('sendNoteBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞–±—ñ–≤
        const tabNotesBtn = document.getElementById('tabNotesBtn');
        const tabArtBtn = document.getElementById('tabArtBtn');
        const notesTab = document.getElementById('notesTab');
        const artTab = document.getElementById('artTab');
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ –∞—Ä—Ç—É
        const canvas = document.getElementById('pixel-canvas');
        const ctx = canvas.getContext('2d');
        const clearArtBtn = document.getElementById('clearArtBtn');
        const toggleColorBtn = document.getElementById('toggleColorBtn');
        const currentColorIndicator = document.getElementById('currentColorIndicator');
        
        let currentCellKey = null;
        let allNotes = loadNotes();
        let pixelGrid = []; // –ú–∞—Å–∏–≤ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –ø—ñ–∫—Å–µ–ª—ñ–≤
        let drawingColor = getComputedStyle(document.documentElement).getPropertyValue('--draw-color').trim(); // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä

        // ----------------------------------------------------
        // üíæ LOCAL STORAGE –§–£–ù–ö–¶–Ü–á
        // ----------------------------------------------------

        function loadNotes() {
            try {
                const data = localStorage.getItem('morstrix_drafts_v2'); 
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è LocalStorage:", e);
                return {};
            }
        }

        function saveNotes() {
            try {
                localStorage.setItem('morstrix_drafts_v2', JSON.stringify(allNotes));
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è LocalStorage:", e);
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        // ----------------------------------------------------
        // üñºÔ∏è –õ–û–ì–Ü–ö–ê –ü–Ü–ö–°–ï–õ–¨–ù–û–ì–û –ê–†–¢–£
        // ----------------------------------------------------

        function initPixelGrid() {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—é —Å—ñ—Ç–∫—É
            pixelGrid = Array(ART_GRID_SIZE).fill(0).map(() => 
                Array(ART_GRID_SIZE).fill(getComputedStyle(document.documentElement).getPropertyValue('--erase-color').trim())
            );
        }

        function loadArt(cellKey) {
            initPixelGrid(); // –°–∫–∏–¥–∞—î–º–æ –ø–µ—Ä–µ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
            const cellData = allNotes[cellKey] || {};
            // Art –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ –æ–±'—î–∫—Ç {type: 'art', data: pixelArray}
            const artData = cellData.art; 
            
            if (artData && artData.length === ART_GRID_SIZE && artData[0].length === ART_GRID_SIZE) {
                pixelGrid = artData;
            }
            redrawCanvas();
        }
        
        function saveArt(cellKey) {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—ñ—Ç–∫—É –ø—ñ–∫—Å–µ–ª—ñ–≤, —è–∫—â–æ –≤–æ–Ω–∞ –Ω–µ –ø–æ—Ä–æ–∂–Ω—è
            const isBlank = pixelGrid.flat().every(color => color === getComputedStyle(document.documentElement).getPropertyValue('--erase-color').trim());
            
            if (isBlank) {
                if (allNotes[cellKey]) {
                    delete allNotes[cellKey].art;
                    if (Object.keys(allNotes[cellKey]).length === 0) {
                        delete allNotes[cellKey];
                    }
                }
            } else {
                if (!allNotes[cellKey]) allNotes[cellKey] = {};
                allNotes[cellKey].art = pixelGrid;
            }
        }

        function redrawCanvas() {
            const eraseColor = getComputedStyle(document.documentElement).getPropertyValue('--erase-color').trim();
            for (let r = 0; r < ART_GRID_SIZE; r++) {
                for (let c = 0; c < ART_GRID_SIZE; c++) {
                    ctx.fillStyle = pixelGrid[r][c] || eraseColor;
                    ctx.fillRect(c * PIXEL_SIZE, r * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                    
                    // –ú–∞–ª—é—î–º–æ —Å—ñ—Ç–∫—É —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º
                    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid-color').trim();
                    ctx.lineWidth = 1;
                    ctx.strokeRect(c * PIXEL_SIZE, r * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                }
            }
        }
        
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches && e.touches.length > 0) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø—ñ–∫—Å–µ–ª—å —É —Å—ñ—Ç—Ü—ñ
            const col = Math.floor(x / PIXEL_SIZE);
            const row = Math.floor(y / PIXEL_SIZE);
            
            return { row, col };
        }
        
        function handleDraw(e) {
            e.preventDefault();
            const { row, col } = getCoords(e);
            
            if (row >= 0 && row < ART_GRID_SIZE && col >= 0 && col < ART_GRID_SIZE) {
                 // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: —è–∫—â–æ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –≤–∂–µ –∑–∞—Ñ–∞—Ä–±–æ–≤–∞–Ω–∞, —Å—Ç–∏—Ä–∞—î–º–æ
                const eraseColor = getComputedStyle(document.documentElement).getPropertyValue('--erase-color').trim();
                const newColor = (pixelGrid[row][col] === drawingColor) ? eraseColor : drawingColor;

                pixelGrid[row][col] = newColor;
                redrawCanvas();
                saveArt(currentCellKey); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞—Ä—Ç—É
            }
        }

        // ----------------------------------------------------
        // üóÇÔ∏è –õ–û–ì–Ü–ö–ê –¢–ê–ë–Ü–í –¢–ê –Ü–ù–¢–ï–†–§–ï–ô–°–£
        // ----------------------------------------------------

        function switchTab(tabId) {
            // –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –≤—Å—ñ
            tabNotesBtn.classList.remove('active');
            tabArtBtn.classList.remove('active');
            notesTab.classList.remove('active');
            artTab.classList.remove('active');
            
            // –ê–∫—Ç–∏–≤—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π
            if (tabId === 'notes') {
                tabNotesBtn.classList.add('active');
                notesTab.classList.add('active');
            } else if (tabId === 'art') {
                tabArtBtn.classList.add('active');
                artTab.classList.add('active');
                loadArt(currentCellKey); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞—Ä—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ
            }
        }
        
        // ... (–§—É–Ω–∫—Ü—ñ—ó renderNoteList, addNote, deleteNote –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –º–∞–π–∂–µ –Ω–µ–∑–º—ñ–Ω–Ω–∏–º–∏) ...
        
        function renderNoteList(cellKey) {
            noteListContainer.innerHTML = '';
            // –ù–æ—Ç–∞—Ç–∫–∏ —Ç–µ–ø–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É allNotes[cellKey].notes
            const notes = allNotes[cellKey] && allNotes[cellKey].notes ? allNotes[cellKey].notes : [];
            
            if (notes.length === 0) {
                noteListContainer.innerHTML = '<div style="color: #999; text-align: center; margin-top: 20px;">–ù–æ—Ç–∞—Ç–æ–∫ –Ω–µ–º–∞—î. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É!</div>';
                return;
            }

            notes.forEach((note, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';
                noteItem.innerHTML = `<span style="color: var(--accent-color);">${index + 1}.</span> ${note} <button onclick="deleteNote('${cellKey}', ${index})" style="float: right; background: red; color: white; border: none; padding: 2px 5px; cursor: pointer; font-family: monospace;">X</button>`;
                noteListContainer.appendChild(noteItem);
            });
        }
        
        window.deleteNote = (cellKey, index) => {
            if (allNotes[cellKey] && allNotes[cellKey].notes && allNotes[cellKey].notes.length > index) {
                allNotes[cellKey].notes.splice(index, 1);
                
                if (allNotes[cellKey].notes.length === 0) {
                    delete allNotes[cellKey].notes;
                }
                
                // –í–∏–¥–∞–ª—è—î–º–æ –∫–ª—ñ—Ç–∏–Ω–∫—É, —è–∫—â–æ –≤–æ–Ω–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é –ø–æ—Ä–æ–∂–Ω—è
                if (Object.keys(allNotes[cellKey]).length === 0) {
                     delete allNotes[cellKey];
                }
                
                renderNoteList(cellKey);
                updateCellDisplay(cellKey);
                saveNotes();
            }
        };

        function addNote() {
            if (currentCellKey) {
                const content = noteContentInput.value.trim();
                if (content === '') {
                    alert("–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –Ω–æ—Ç–∞—Ç–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º.");
                    return;
                }
                
                if (!allNotes[currentCellKey]) allNotes[currentCellKey] = {};
                if (!allNotes[currentCellKey].notes) allNotes[currentCellKey].notes = [];
                
                allNotes[currentCellKey].notes.push(content);
                noteContentInput.value = '';
                renderNoteList(currentCellKey);
                updateCellDisplay(currentCellKey); 
                saveNotes();
            }
        }

        function openCell(cellKey, row, col) {
            currentCellKey = cellKey;
            modalTitle.textContent = `–ö—ñ–º–Ω–∞—Ç–∞ [${row}, ${col}]`;
            
            noteContentInput.value = ''; 
            renderNoteList(cellKey); 
            
            // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤–∫–ª–∞–¥–∫—É "–ù–æ—Ç–∞—Ç–∫–∏"
            switchTab('notes');
            
            noteModal.style.display = 'flex';
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.BackButton.show();
            }
        }
        
        function updateCellDisplay(cellKey) {
            const row = cellKey.split('_')[1];
            const col = cellKey.split('_')[2];
            const currentCellDiv = document.querySelector(`.cell[data-key="${cellKey}"]`);
            if (currentCellDiv) {
                const cellData = allNotes[cellKey] || {};
                const noteCount = cellData.notes ? cellData.notes.length : 0;
                const hasArt = !!cellData.art;
                const hasContent = noteCount > 0 || hasArt;

                let indicator = '';
                if (noteCount > 0) indicator += `üìù(${noteCount})`;
                if (hasArt) indicator += (noteCount > 0 ? ' + ' : '') + 'üé®';
                if (hasContent) indicator = `<div class="note-indicator">‚ö°Ô∏è ${indicator}</div>`;

                currentCellDiv.innerHTML = `[${row}, ${col}] ${indicator}`;
            }
        }

        function saveAllAndClose() {
             // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞—Ä—Ç—É –≤–∂–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤ handleDraw
            currentCellKey = null;
            closeModal();
        }

        function closeModal() {
            noteModal.style.display = 'none';
            currentCellKey = null;
            if (window.Telegram && window.Telegram.WebApp) {
                 window.Telegram.WebApp.BackButton.hide(); 
            }
        }

        function sendNote() {
            if (currentCellKey) {
                const cellData = allNotes[currentCellKey] || {};
                let dataToSend = '';
                let successMessage = '';
                
                if (cellData.notes && cellData.notes.length > 0) {
                    // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—é –Ω–æ—Ç–∞—Ç–∫—É
                    dataToSend = cellData.notes.pop();
                    successMessage = `–ù–û–¢–ê–¢–ö–ê [${currentCellKey}]`;
                    if (cellData.notes.length === 0) delete cellData.notes;
                } else if (cellData.art) {
                    // –ù–∞–¥—Å–∏–ª–∞—î–º–æ JSON-—Ä—è–¥–æ–∫ –∞—Ä—Ç—É
                    dataToSend = JSON.stringify(cellData.art);
                    successMessage = `–ê–†–¢ [${currentCellKey}]`;
                    delete cellData.art;
                } else {
                    alert("–£ —Ü—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ –Ω–µ–º–∞—î –≤–º—ñ—Å—Ç—É –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è.");
                    return;
                }
                
                if (Object.keys(cellData).length === 0) delete allNotes[currentCellKey];
                saveNotes();
                
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.sendData(successMessage + '|' + dataToSend); 
                    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º '–ù–û–¢–ê–¢–ö–ê|' –∞–±–æ '–ê–†–¢|' –¥–ª—è –ª–µ–≥—à–æ—ó –æ–±—Ä–æ–±–∫–∏ –±–æ—Ç–æ–º
                    window.Telegram.WebApp.close();
                } else {
                    alert("–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ Telegram WebApp API.");
                }
                
                updateCellDisplay(currentCellKey);
            }
        }


        // ----------------------------------------------------
        // ‚ö°Ô∏è –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.BackButton.hide();
            }
            generateGrid();
            initPixelGrid(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å—ñ—Ç–∫—É –∞—Ä—Ç—É
            redrawCanvas(); // –ú–∞–ª—é—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –∫–∞–Ω–≤–∞—Å

            // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Ç–∞–±—ñ–≤
            tabNotesBtn.addEventListener('click', () => switchTab('notes'));
            tabArtBtn.addEventListener('click', () => switchTab('art'));
            
            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∞—Ä—Ç—É
            canvas.addEventListener('click', handleDraw);
            canvas.addEventListener('touchstart', handleDraw);
            canvas.addEventListener('touchmove', handleDraw);
            
            clearArtBtn.addEventListener('click', () => {
                initPixelGrid();
                redrawCanvas();
                saveArt(currentCellKey);
                updateCellDisplay(currentCellKey);
            });
            
            toggleColorBtn.addEventListener('click', () => {
                // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–∏–∫–∞—î–º–æ –º—ñ–∂ –¥–≤–æ–º–∞ –∫–æ–ª—å–æ—Ä–∞–º–∏ –¥–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è
                const drawColor = getComputedStyle(document.documentElement).getPropertyValue('--draw-color').trim();
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
                
                if (drawingColor === drawColor) {
                    drawingColor = accentColor;
                    currentColorIndicator.textContent = '**–ê–ö–¶–ï–ù–¢**';
                    currentColorIndicator.style.color = accentColor;
                } else {
                    drawingColor = drawColor;
                    currentColorIndicator.textContent = '**–Ø–°–ö–†–ê–í–ò–ô**';
                    currentColorIndicator.style.color = drawColor;
                }
            });

            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            addNoteBtn.addEventListener('click', addNote);
            saveNoteBtn.addEventListener('click', saveAllAndClose);
            sendNoteBtn.addEventListener('click', sendNote); 
            closeModalBtn.addEventListener('click', closeModal); 

            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.onEvent('backButtonClicked', saveAllAndClose);
            }
        });
    </script>
</body>
</html>