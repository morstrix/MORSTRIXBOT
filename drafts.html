drafts.html
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORSTRIX | –ß–µ—Ä–Ω–µ—Ç–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap'); /* –†–µ—Ç—Ä–æ-—à—Ä–∏—Ñ—Ç */

        :root {
            --bg-color: #1a1a1a; /* –¢–µ–º–Ω–∏–π –≥—Ä–∞—Ñ—ñ—Ç */
            --grid-color: #383838; /* –õ—ñ–Ω—ñ—ó —Å—ñ—Ç–∫–∏ */
            --text-color: #00ff00; /* –†–µ—Ç—Ä–æ-–∑–µ–ª–µ–Ω–∏–π */
            --accent-color: #ff00ff; /* –ú–∞–¥–∂–µ–Ω—Ç–∞ */
            --dark-cell-color: #111111; /* –¢–µ–º–Ω—ñ—à–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ —Å—ñ—Ç–∫–∏ */
            --light-cell-color: #222222; /* –°–≤—ñ—Ç–ª—ñ—à–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ —Å—ñ—Ç–∫–∏ */
            --draw-color: #ffffff; /* –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–ª—ñ—Ä –º–∞–ª—é–≤–∞–Ω–Ω—è */
            --erase-color: #000000; /* –ö–æ–ª—ñ—Ä —Å—Ç–∏—Ä–∞–Ω–Ω—è */
            --cell-size: 80px;
            --button-bg: #009900; /* –ó–µ–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ */
            --button-hover: #00cc00;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            touch-action: pan-y;
            image-rendering: pixelated;
            font-size: 10px;
        }
        
        @supports not (font-family: 'Press Start 2P') {
             body {
                font-family: monospace;
            }
        }

        .header {
            text-align: center;
            padding: 10px;
            background-color: var(--grid-color);
            color: var(--draw-color);
            box-shadow: 0 4px 0 var(--accent-color);
            margin-bottom: 5px;
            text-shadow: 2px 2px 0 #000;
            font-size: 14px;
        }

        .grid-container {
            /* 4 –ö–û–õ–û–ù–ö–ò –ù–ê 7 –†–Ø–î–ö–Ü–í */
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 1px; 
            padding: 10px;
            background-color: var(--grid-color); 
        }

        .cell {
            min-height: var(--cell-size);
            background-color: var(--dark-cell-color); /* –¢–µ–º–Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ */
            border: 1px solid var(--grid-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.1s;
            text-align: center;
            padding: 5px;
            font-size: 8px;
            box-shadow: 2px 2px 0 #000;
        }

        /* –®–∞—Ö–º–∞—Ç–Ω–∏–π –≤—ñ–∑–µ—Ä—É–Ω–æ–∫ */
        .grid-container .cell:nth-child(8n+1),
        .grid-container .cell:nth-child(8n+3),
        .grid-container .cell:nth-child(8n+6),
        .grid-container .cell:nth-child(8n+8) {
            background-color: var(--light-cell-color);
        }
        
        .grid-container .cell:nth-child(8n+2),
        .grid-container .cell:nth-child(8n+4),
        .grid-container .cell:nth-child(8n+5),
        .grid-container .cell:nth-child(8n+7) {
            background-color: var(--dark-cell-color);
        }


        .cell:hover {
            box-shadow: 0 0 5px var(--text-color);
        }

        .draft-indicator {
            color: var(--accent-color);
            font-size: 14px;
            text-shadow: 1px 1px 0 #000;
            margin-top: 5px;
        }
        
        /* --- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98); 
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            width: 95%;
            max-width: 600px;
            height: 80vh; 
            background: var(--bg-color);
            border: 2px solid var(--text-color); 
            padding: 20px;
            box-shadow: 4px 4px 0 var(--accent-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .modal-title {
            color: var(--draw-color);
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #000;
            font-size: 14px;
        }
        
        /* --- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è (–°–ø—ñ–ª—å–Ω—ñ) --- */
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
            max-width: 300px;
            margin-top: auto; 
        }

        .action-btn {
            background-color: var(--button-bg);
            color: var(--bg-color);
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 10px;
            box-shadow: 2px 2px 0 #000;
            flex-grow: 1; 
            transition: background-color 0.1s;
        }
        
        .action-btn:hover {
             background-color: var(--button-hover);
        }
        
        .cancel-btn {
            background-color: var(--grid-color);
            color: var(--draw-color);
        }
        
        .delete-btn {
            background-color: #990000; /* –ß–µ—Ä–≤–æ–Ω–∏–π */
        }
        
        /* --- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–∏–±–æ—Ä—É —Ç–∏–ø—É --- */
        #selectModal .button-group {
            flex-direction: column;
            gap: 20px;
            margin: auto;
        }
        
        #selectModal .action-btn {
            padding: 15px;
        }
        
        /* --- –†–µ–¥–∞–∫—Ç–æ—Ä –ó–∞–º—ñ—Ç–∫–∏ (Note) --- */
        #noteModal textarea {
            width: 100%;
            flex-grow: 1;
            padding: 10px;
            background-color: var(--dark-cell-color);
            color: var(--text-color);
            border: 1px solid var(--grid-color);
            font-family: monospace;
            font-size: 12px;
            resize: none;
            box-sizing: border-box;
            box-shadow: inset 1px 1px 0 #000;
        }
        
        #noteModal .button-group {
            margin-top: 20px;
        }
        
        /* --- –†–µ–¥–∞–∫—Ç–æ—Ä –ê—Ä—Ç—É (Art) --- */
        #art-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        
        #pixel-canvas {
            border: 2px solid var(--draw-color); 
            box-shadow: 0 0 10px var(--accent-color);
            image-rendering: pixelated;
            touch-action: none; 
            background-color: var(--erase-color);
            width: 256px;
            height: 256px;
        }
        
        .art-controls {
            margin-top: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 256px; 
            justify-content: space-between;
        }
        
        .tool-indicator {
            color: var(--draw-color);
            font-size: 10px;
            padding: 8px;
            background-color: var(--grid-color);
            flex-grow: 1;
            text-align: center;
        }

        .art-btn {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 8px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 10px;
            box-shadow: 2px 2px 0 #000;
        }
        
        /* --- –†–µ–¥–∞–∫—Ç–æ—Ä –ü—É—à–∞ (Push) --- */
        #pushModal form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            flex-grow: 1;
        }
        
        #pushModal label {
            font-size: 10px;
            color: var(--text-color);
        }
        
        #pushModal input, #pushModal textarea {
            padding: 10px;
            background-color: var(--dark-cell-color);
            color: var(--text-color);
            border: 1px solid var(--grid-color);
            font-family: monospace;
            font-size: 12px;
            box-shadow: inset 1px 1px 0 #000;
            box-sizing: border-box;
            width: 100%;
        }
        
        #pushModal textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        #pushModal .button-group {
            margin-top: 20px;
        }

    </style>
</head>
<body>

    <div class="header">
        MORSTRIX | –ß–ï–†–ù–ï–¢–ö–ò 4x7
    </div>

    <div id="grid-container" class="grid-container">
        </div>

    <div id="selectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">–ß–ï–†–ù–ï–¢–ö–ê [<span id="selectCoords">X, Y</span>]</h2>
            
            <div class="button-group">
                <button id="selectNoteBtn" class="action-btn">üìù –ó–ê–ú–Ü–¢–ö–ê</button>
                <button id="selectArtBtn" class="action-btn">üé® –ê–†–¢ (8x8)</button>
                <button id="selectPushBtn" class="action-btn">‚è∞ –ù–ê–ì–ê–î–£–í–ê–ù–ù–Ø (–ü–£–®)</button>
            </div>
            
            <div class="button-group" style="max-width: 100px; margin-top: 40px;">
                <button id="cancelSelectBtn" class="action-btn cancel-btn">–°–ö–ê–°–£–í–ê–¢–ò</button>
            </div>
        </div>
    </div>

    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">üìù –ó–ê–ú–Ü–¢–ö–ê [<span id="noteCoords">X, Y</span>]</h2>
            <textarea id="noteTextarea" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à —Ç–µ–∫—Å—Ç..."></textarea>
            
            <div class="button-group">
                <button id="saveNoteBtn" class="action-btn">–ó–ë–ï–†–ï–ì–¢–ò</button>
                <button id="deleteNoteBtn" class="action-btn delete-btn">–í–ò–î–ê–õ–ò–¢–ò</button>
                <button id="closeNoteBtn" class="action-btn cancel-btn">–ó–ê–ö–†–ò–¢–ò</button>
            </div>
        </div>
    </div>
    
    <div id="artModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">üé® –ê–†–¢ [<span id="artCoords">X, Y</span>] (8x8)</h2>
            
            <div id="art-container">
                <canvas id="pixel-canvas" width="256" height="256"></canvas>
            </div>
            
            <div class="art-controls">
                <div id="artToolIndicator" class="tool-indicator">
                    –Ü–ù–°–¢–†–£–ú–ï–ù–¢: **–ö–ò–°–¢–¨**
                </div>
                <button id="clearArtBtn" class="art-btn">–û–ß–ò–°–¢–ò–¢–ò</button>
                <button id="toggleToolBtn" class="art-btn">
                    <span id="artToolName">–õ–ê–°–¢–ò–ö</span>
                </button>
            </div>

            <div class="button-group" style="max-width: 350px;">
                <button id="saveArtAndCloseBtn" class="action-btn">–ó–ë–ï–†–ï–ì–¢–ò & –ó–ê–ö–†–ò–¢–ò</button>
                <button id="sendArtBtn" class="action-btn">–ù–ê–î–Ü–°–õ–ê–¢–ò</button>
            </div>
        </div>
    </div>

    <div id="pushModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">‚è∞ –ù–ê–ì–ê–î–£–í–ê–ù–ù–Ø [<span id="pushCoords">X, Y</span>]</h2>
            
            <form id="pushForm">
                 <label for="pushTextarea">–¢–ï–ö–°–¢ –ù–ê–ì–ê–î–£–í–ê–ù–ù–Ø:</label>
                 <textarea id="pushTextarea" placeholder="–©–æ –Ω–∞–≥–∞–¥–∞—Ç–∏?"></textarea>
                 
                 <label for="pushDateTime">–ß–ê–° –ù–ê–î–Ü–°–õ–ê–ù–ù–Ø:</label>
                 <input type="datetime-local" id="pushDateTime" required>
            </form>
            
            <div class="button-group">
                <button id="schedulePushBtn" class="action-btn">–ó–ê–ü–õ–ê–ù–£–í–ê–¢–ò</button>
                <button id="deletePushBtn" class="action-btn delete-btn">–í–ò–î–ê–õ–ò–¢–ò</button>
                <button id="closePushBtn" class="action-btn cancel-btn">–ó–ê–ö–†–ò–¢–ò</button>
            </div>
        </div>
    </div>


    <script>
        const GRID_ROWS = 7;
        const GRID_COLS = 4;
        const ART_GRID_SIZE = 8; // 8x8 –ø—ñ–∫—Å–µ–ª—ñ–≤
        const CANVAS_SIZE = 256;
        const PIXEL_SIZE = CANVAS_SIZE / ART_GRID_SIZE; 
        
        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—ñ–≤ –∑ CSS –∑–º—ñ–Ω–Ω–∏—Ö
        const getCssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        const WHITE_COLOR = getCssVar('--draw-color'); 
        const ERASER_COLOR = getCssVar('--erase-color'); 
        const GRID_COLOR = getCssVar('--grid-color'); 

        const gridContainer = document.getElementById('grid-container');
        
        // –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞
        const selectModal = document.getElementById('selectModal');
        const noteModal = document.getElementById('noteModal');
        const artModal = document.getElementById('artModal');
        const pushModal = document.getElementById('pushModal');

        // –ï–ª–µ–º–µ–Ω—Ç–∏ –ó–∞–º—ñ—Ç–∫–∏
        const noteTextarea = document.getElementById('noteTextarea');
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ –ê—Ä—Ç—É
        const canvas = document.getElementById('pixel-canvas');
        const ctx = canvas.getContext('2d');
        const artToolIndicator = document.getElementById('artToolIndicator');
        const artToolNameSpan = document.getElementById('artToolName');

        // –ï–ª–µ–º–µ–Ω—Ç–∏ –ü—É—à–∞
        const pushTextarea = document.getElementById('pushTextarea');
        const pushDateTime = document.getElementById('pushDateTime');
        
        let currentCellKey = null;
        let allDrafts = loadDrafts();
        let pixelGrid = []; // –ú–∞—Å–∏–≤ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –ø—ñ–∫—Å–µ–ª—ñ–≤ –∞—Ä—Ç—É
        let currentTool = 'brush'; 
        let isDrawing = false; 

        // ----------------------------------------------------
        // üíæ LOCAL STORAGE –§–£–ù–ö–¶–Ü–á
        // ----------------------------------------------------

        function loadDrafts() {
            try {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –∫–ª—é—á –¥–ª—è –≤—Å—ñ—Ö —á–µ—Ä–Ω–µ—Ç–æ–∫
                const data = localStorage.getItem('morstrix_drafts_v1'); 
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è LocalStorage:", e);
                return {};
            }
        }

        function saveDrafts() {
            try {
                localStorage.setItem('morstrix_drafts_v1', JSON.stringify(allDrafts));
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è LocalStorage:", e);
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        // ----------------------------------------------------
        // üñºÔ∏è –õ–û–ì–Ü–ö–ê –ü–Ü–ö–°–ï–õ–¨–ù–û–ì–û –ê–†–¢–£
        // ----------------------------------------------------

        function initPixelGrid(artData = null) {
            pixelGrid = Array(ART_GRID_SIZE).fill(0).map(() => 
                Array(ART_GRID_SIZE).fill(ERASER_COLOR)
            );
             if (artData) {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å–Ω—É—é—á–∏–π –∞—Ä—Ç
                for(let r=0; r<ART_GRID_SIZE; r++) {
                    for(let c=0; c<ART_GRID_SIZE; c++) {
                        if (artData[r] && artData[r][c]) {
                             pixelGrid[r][c] = artData[r][c];
                        }
                    }
                }
             }
        }

        function redrawCanvas() {
            for (let r = 0; r < ART_GRID_SIZE; r++) {
                for (let c = 0; c < ART_GRID_SIZE; c++) {
                    ctx.fillStyle = pixelGrid[r][c] || ERASER_COLOR;
                    ctx.fillRect(c * PIXEL_SIZE, r * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                    
                    // –ú–∞–ª—é—î–º–æ —Å—ñ—Ç–∫—É
                    ctx.strokeStyle = GRID_COLOR;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(c * PIXEL_SIZE, r * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                }
            }
        }
        
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches && e.touches.length > 0) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            
            const col = Math.floor(x / PIXEL_SIZE);
            const row = Math.floor(y / PIXEL_SIZE);
            
            return { row, col };
        }
        
        function applyTool(row, col) {
            if (row >= 0 && row < ART_GRID_SIZE && col >= 0 && col < ART_GRID_SIZE) {
                const targetColor = currentTool === 'brush' ? WHITE_COLOR : ERASER_COLOR;
                
                // –Ø–∫—â–æ –∫–ª—ñ–∫–Ω—É–ª–∏ –Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫—É –∑ –ø–æ—Ç—Ä—ñ–±–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º, —ñ–Ω–≤–µ—Ä—Ç—É—î–º–æ
                if (pixelGrid[row][col] === targetColor) {
                    pixelGrid[row][col] = currentTool === 'brush' ? ERASER_COLOR : WHITE_COLOR;
                } else {
                    pixelGrid[row][col] = targetColor;
                }
                
                redrawCanvas();
                saveDraft(currentCellKey, 'art', pixelGrid); 
                updateCellDisplay(currentCellKey);
            }
        }
        
        function handlePointerStart(e) {
            e.preventDefault();
            isDrawing = true;
            const { row, col } = getCoords(e);
            applyTool(row, col);
        }

        function handlePointerMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const { row, col } = getCoords(e);
            applyTool(row, col);
        }
        
        function handlePointerEnd() {
            isDrawing = false;
        }

        function toggleTool() {
            currentTool = currentTool === 'brush' ? 'eraser' : 'brush';
            const toolName = currentTool === 'brush' ? '**–ö–ò–°–¢–¨**' : '**–õ–ê–°–¢–ò–ö**';
            artToolIndicator.innerHTML = `–Ü–ù–°–¢–†–£–ú–ï–ù–¢: ${toolName}`;
            artToolNameSpan.textContent = currentTool === 'brush' ? '–õ–ê–°–¢–ò–ö' : '–ö–ò–°–¢–¨';
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        }
        
        // ----------------------------------------------------
        // üèóÔ∏è –ì–ï–ù–ï–†–ê–¶–Ü–Ø –°–Ü–¢–ö–ò –¢–ê –õ–û–ì–Ü–ö–ê –ß–ï–†–ù–ï–¢–û–ö
        // ----------------------------------------------------

        function generateGrid() {
            gridContainer.innerHTML = '';
            for (let row = 1; row <= GRID_ROWS; row++) {
                for (let col = 1; col <= GRID_COLS; col++) {
                    const cellKey = `cell_${row}_${col}`;
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';
                    cellDiv.dataset.key = cellKey;
                    
                    cellDiv.addEventListener('click', () => openCell(cellKey, row, col));
                    gridContainer.appendChild(cellDiv);
                    updateCellDisplay(cellKey); 
                }
            }
        }

        function updateCellDisplay(cellKey) {
            const row = cellKey.split('_')[1];
            const col = cellKey.split('_')[2];
            const currentCellDiv = document.querySelector(`.cell[data-key="${cellKey}"]`);
            if (currentCellDiv) {
                const draft = allDrafts[cellKey];
                let indicator = '';
                
                if (draft) {
                    switch(draft.type) {
                        case 'note':
                            indicator = 'üìù';
                            break;
                        case 'art':
                            indicator = 'üé®';
                            break;
                        case 'push':
                            indicator = '‚è∞';
                            break;
                    }
                }

                currentCellDiv.innerHTML = `[${row}, ${col}] ${indicator ? `<div class="draft-indicator">‚ö°Ô∏è ${indicator}</div>` : ''}`;
            }
        }
        
        function getDraft(cellKey) {
            return allDrafts[cellKey] || null;
        }

        function saveDraft(cellKey, type, data) {
            const isEmpty = (type === 'note' && !data.trim()) || 
                            (type === 'art' && isArtBlank(data)) || 
                            (type === 'push' && (!data.text || !data.datetime));

            if (isEmpty) {
                delete allDrafts[cellKey];
            } else {
                allDrafts[cellKey] = { type, data };
            }
            saveDrafts();
            updateCellDisplay(cellKey);
        }

        function deleteDraft(cellKey) {
            delete allDrafts[cellKey];
            saveDrafts();
            updateCellDisplay(cellKey);
        }
        
        function isArtBlank(grid) {
             return grid.flat().every(color => color === ERASER_COLOR);
        }

        function openCell(cellKey, row, col) {
            currentCellKey = cellKey;
            const coords = `${row}, ${col}`;
            const existingDraft = getDraft(cellKey);
            
            // –Ø–∫—â–æ —á–µ—Ä–Ω–µ—Ç–∫–∞ —ñ—Å–Ω—É—î, –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (existingDraft) {
                switch (existingDraft.type) {
                    case 'note':
                        openNoteModal(coords, existingDraft.data);
                        break;
                    case 'art':
                        openArtModal(coords, existingDraft.data);
                        break;
                    case 'push':
                        openPushModal(coords, existingDraft.data);
                        break;
                }
            } else {
                // –Ø–∫—â–æ —á–µ—Ä–Ω–µ—Ç–∫–∏ –Ω–µ–º–∞—î, –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–∫–Ω–æ –≤–∏–±–æ—Ä—É —Ç–∏–ø—É
                document.getElementById('selectCoords').textContent = coords;
                selectModal.style.display = 'flex';
                showBackButton();
            }
        }
        
        function openNoteModal(coords, text = '') {
            selectModal.style.display = 'none';
            document.getElementById('noteCoords').textContent = coords;
            noteTextarea.value = text;
            noteModal.style.display = 'flex';
            showBackButton();
        }

        function openArtModal(coords, artData = null) {
            selectModal.style.display = 'none';
            document.getElementById('artCoords').textContent = coords;
            
            initPixelGrid(artData); 
            redrawCanvas(); 
            
            currentTool = 'brush';
            artToolIndicator.innerHTML = `–Ü–ù–°–¢–†–£–ú–ï–ù–¢: **–ö–ò–°–¢–¨**`;
            artToolNameSpan.textContent = '–õ–ê–°–¢–ò–ö';
            
            artModal.style.display = 'flex';
            showBackButton();
        }
        
        function openPushModal(coords, pushData = { text: '', datetime: '' }) {
            selectModal.style.display = 'none';
            document.getElementById('pushCoords').textContent = coords;
            pushTextarea.value = pushData.text || '';
            pushDateTime.value = pushData.datetime || '';
            pushModal.style.display = 'flex';
            showBackButton();
        }

        // --- –ó–∞–∫—Ä–∏—Ç—Ç—è —Ç–∞ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è/–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è ---
        
        function closeModal(modalElement) {
            modalElement.style.display = 'none';
            hideBackButton();
            // –Ø–∫—â–æ –º–∏ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –≥–æ–ª–æ–≤–Ω–æ—ó —Å—ñ—Ç–∫–∏
            if (modalElement !== selectModal) {
                 // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó —á–µ—Ä–Ω–µ—Ç–∫–∏, —â–æ–± –Ω–µ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ —Å–µ–ª–µ–∫—Ç –∑–Ω–æ–≤—É
                 if (!getDraft(currentCellKey)) {
                     currentCellKey = null;
                 }
            }
        }
        
        function showBackButton() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.BackButton.show();
            }
        }

        function hideBackButton() {
             if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.BackButton.hide();
            }
        }

        // --- –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ ---
        
        document.getElementById('cancelSelectBtn').addEventListener('click', () => closeModal(selectModal));
        
        document.getElementById('selectNoteBtn').addEventListener('click', () => openNoteModal(document.getElementById('selectCoords').textContent));
        document.getElementById('selectArtBtn').addEventListener('click', () => openArtModal(document.getElementById('selectCoords').textContent));
        document.getElementById('selectPushBtn').addEventListener('click', () => openPushModal(document.getElementById('selectCoords').textContent));
        
        // NOTE Handlers
        document.getElementById('saveNoteBtn').addEventListener('click', () => {
             saveDraft(currentCellKey, 'note', noteTextarea.value);
             closeModal(noteModal);
        });
        document.getElementById('deleteNoteBtn').addEventListener('click', () => {
             deleteDraft(currentCellKey);
             closeModal(noteModal);
        });
        document.getElementById('closeNoteBtn').addEventListener('click', () => closeModal(noteModal));

        // ART Handlers
        document.getElementById('clearArtBtn').addEventListener('click', () => {
             if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å –∞—Ä—Ç?")) {
                 initPixelGrid();
                 redrawCanvas();
                 saveDraft(currentCellKey, 'art', pixelGrid); // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ –∞—Ä—Ç—É
             }
        });
        document.getElementById('toggleToolBtn').addEventListener('click', toggleTool);
        document.getElementById('saveArtAndCloseBtn').addEventListener('click', () => closeModal(artModal)); // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤–∂–µ –≤—ñ–¥–±—É–ª–æ—Å—è –ø—Ä–∏ –º–∞–ª—é–≤–∞–Ω–Ω—ñ

        document.getElementById('sendArtBtn').addEventListener('click', () => {
             const draft = getDraft(currentCellKey);
             if (!draft || draft.type !== 'art') {
                 alert("–ù–µ–º–∞—î –∞—Ä—Ç—É –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è.");
                 return;
             }
             
             // –ù–∞–¥—Å–∏–ª–∞—î–º–æ JSON-—Ä—è–¥–æ–∫ –∞—Ä—Ç—É
             const dataToSend = JSON.stringify(draft.data);
             const prefix = `ART|${currentCellKey}|`;
             
             if (window.Telegram && window.Telegram.WebApp) {
                 window.Telegram.WebApp.sendData(prefix + dataToSend); 
                 deleteDraft(currentCellKey); // –í–∏–¥–∞–ª—è—î–º–æ –ø—ñ—Å–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è
                 window.Telegram.WebApp.close();
             } else {
                 alert("–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ Telegram WebApp API.");
             }
        });
        
        // PUSH Handlers
        document.getElementById('schedulePushBtn').addEventListener('click', () => {
             const text = pushTextarea.value.trim();
             const datetime = pushDateTime.value;
             
             if (!text || !datetime) {
                 alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ç–∞ —á–∞—Å.");
                 return;
             }
             
             const pushData = { text, datetime };
             saveDraft(currentCellKey, 'push', pushData);
             
             // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è
             const dataToSend = JSON.stringify(pushData);
             const prefix = `PUSH|${currentCellKey}|`;
             
             if (window.Telegram && window.Telegram.WebApp) {
                 window.Telegram.WebApp.sendData(prefix + dataToSend); 
                 deleteDraft(currentCellKey); // –í–∏–¥–∞–ª—è—î–º–æ –ø—ñ—Å–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è
                 window.Telegram.WebApp.close();
             } else {
                 alert("–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ Telegram WebApp API.");
             }
        });
        
        document.getElementById('deletePushBtn').addEventListener('click', () => {
             deleteDraft(currentCellKey);
             closeModal(pushModal);
        });
        document.getElementById('closePushBtn').addEventListener('click', () => closeModal(pushModal));


        // ----------------------------------------------------
        // ‚ö°Ô∏è –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.BackButton.hide();
                window.Telegram.WebApp.expand();
            }
            generateGrid();
            initPixelGrid(); 
            redrawCanvas(); 

            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∞—Ä—Ç—É (–ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –º–∏—à—ñ —Ç–∞ –¥–æ—Ç–∏–∫—É)
            canvas.addEventListener('mousedown', handlePointerStart);
            canvas.addEventListener('mousemove', handlePointerMove);
            document.addEventListener('mouseup', handlePointerEnd);
            
            canvas.addEventListener('touchstart', handlePointerStart);
            canvas.addEventListener('touchmove', handlePointerMove);
            document.addEventListener('touchend', handlePointerEnd);
            
            // –ó–∞–≥–∞–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.onEvent('backButtonClicked', () => {
                     if (noteModal.style.display === 'flex') {
                          closeModal(noteModal);
                     } else if (artModal.style.display === 'flex') {
                          closeModal(artModal);
                     } else if (pushModal.style.display === 'flex') {
                          closeModal(pushModal);
                     } else if (selectModal.style.display === 'flex') {
                          closeModal(selectModal);
                     } else {
                         window.Telegram.WebApp.close();
                     }
                });
            }
        });
    </script>
</body>
</html>